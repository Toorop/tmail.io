<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Api on tmail</title>
    <link>http://tmail.io/tags/api/</link>
    <description>Recent content in Api on tmail</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>fr-fr</language>
    <lastBuildDate>Thu, 28 May 2015 10:24:01 +0200</lastBuildDate>
    <atom:link href="http://tmail.io/tags/api/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Micro-services</title>
      <link>http://tmail.io/doc/microservices/</link>
      <pubDate>Thu, 28 May 2015 10:24:01 +0200</pubDate>
      
      <guid>http://tmail.io/doc/microservices/</guid>
      <description>

&lt;p&gt;Comme un serveur SMTP peut avoir une infinité de fonctionnalités et que l&amp;rsquo;on ne peut les implémenter toutes, tmail dispose d&amp;rsquo;un systéme permettant d&amp;rsquo;ajouter des fonctionalités par le biais de micro-services servis via HTTP.&lt;/p&gt;

&lt;p&gt;Pourquoi des microservices pour étendre tmail ?&lt;/p&gt;

&lt;p&gt;Voyons les contraintes liées à ce besoin:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Fiable: est il vraiment nécessaire de préciser ce point ? ;)&lt;/li&gt;
&lt;li&gt;Facile: n&amp;rsquo;importe qui, à condition d&amp;rsquo;avoir quelques base en programmation, doit être en mesure d&amp;rsquo;étendre tmail pour l&amp;rsquo;adapter à ses besoins.&lt;/li&gt;
&lt;li&gt;Multi language: un langage de programmation spécifique ne doit pas être  imposé pour implémenter une nouvelle fonctionnalité.&lt;/li&gt;
&lt;li&gt;Scalable: on doit pouvoir adapter simplement et rapidement les ressources aux besoins.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Comment y répondre:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;De part leur indépendance vis à vis du logiciel client, les micro-services ne viendront pas impacter tmail en cas de problème. En clair si un micro-service plante, ca ne va pas faire planter tmail.&lt;/li&gt;
&lt;li&gt;HTTP est un protocole répandu, fiable et maîtrisé par de nombreux développeur, il est tout à fait adapté comme protocole de communication entre le client (tmail) et les micro-services. De plus il est facilement scalable.&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://developers.google.com/protocol-buffers/&#34; target=&#34;_blank&#34; title=&#34;Protocol Buffers&#34;&gt; Protocol Buffers &lt;/a&gt; est un format de sérialisation très performant, il permet un contrôle fin sur la structure et le type des donnés échangées, des implémentations existent dans les langages les plus courant,.. bref il semble le parfait candidat pour ce qui concerne le format d&amp;rsquo;échange de données..&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;sommaire:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Sommaire&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#principes:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Principes de base &lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#configuration:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Configuration &lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#parametres:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Paramètres&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#protobuf:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Structure des messages &lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#smtpdreponse:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;SmtpdResponse &lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#hooks:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Points d&amp;rsquo;entré &lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#smtpdnewclient:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Initialisation de la connexion&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#smtpdrcptto:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Commande SMTP RCPT TO&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#smtpddata:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Commande SMTP DATA&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#deliverdgetroutes:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Livraison: routage dynamique&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#exempleimpl:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Exemples d&amp;rsquo;implémentation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#msas:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Micro-Services As Service&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#greysmtpd:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Grey SMTP&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#dkimverif:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Vérification DKIL&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;principes:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Principes de base&lt;/h2&gt;

&lt;p&gt;A différentes étapes de la &amp;ldquo;chaine SMTP&amp;rdquo;, tmail va vérifier si des micro-services sont configurées et le cas échéant il va les interroger.&lt;/p&gt;

&lt;p&gt;Prenons un exemple concret, si un micro-service est configuré pour être interrogé lors de l’établissement d&amp;rsquo;une connexion avec un nouveau client SMTP, tmail va sérialiser l&amp;rsquo;identifiant de la sessions SMTP et l&amp;rsquo;adresse IP du client distant et va les transmettre via une requête HTTP POST vers le micro service.&lt;/p&gt;

&lt;p&gt;Il va attendre (ou pas) la réponse et en fonction de cette dernière va agir en conséquence.&lt;/p&gt;

&lt;p&gt;La tache du micro-service pourrait être, par exemple, de vérifier si l&amp;rsquo;IP est blacklistée sur une RBL, et si c&amp;rsquo;est le cas alors le micro-service demanderait à tmail de refuser la connexion. (ce qui en passant n&amp;rsquo;est pas une bonne idée, mais bon, c&amp;rsquo;est pour l&amp;rsquo;exemple ;) )&lt;/p&gt;

&lt;h2 id=&#34;configuration:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Configuration&lt;/h2&gt;

&lt;p&gt;Pour chaque étape où des micro-services sont appelables, vous allez trouver dans le fichier de configuration une variable de ce type :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Microservices
# On new incomming SMTP connection
TMAIL_MS_SMTPD_NEWCLIENT=&amp;quot;&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Un micro-service est défini par une URL:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;https://ms.tmail.io/smtpdnewclient?param1=x&amp;amp;param2=y
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Avec:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://ms.tmail.io/smtpdnewclient:&#34;&gt;https://ms.tmail.io/smtpdnewclient:&lt;/a&gt; l&amp;rsquo;URL vers laquelle sera posté les données sérialisées.&lt;/li&gt;
&lt;li&gt;&amp;ldquo;param1=x&amp;amp;param2=y&amp;rdquo; les paramètres de configuration de ce micro-service (voir la liste plus bas).
&lt;strong&gt;Attention&lt;/strong&gt; ces paramètres ne seront pas transmis au micro-services.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Il est possible, d&amp;rsquo;appeler plusieurs micro-services en séparant les URL d&amp;rsquo;un point virgule.&lt;/p&gt;

&lt;p&gt;Par exemple :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;TMAIL_MS_SMTPD_NEWCLIENT=&amp;quot;https://ms.tmail.io/check-spamcop?timeout=15; https://ms.tmail.io/stats?fireandforget=true&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Dans ce cas tmail va appeler &lt;a href=&#34;https://ms.tmail.io/check-spamcop&#34;&gt;https://ms.tmail.io/check-spamcop&lt;/a&gt; et ensuite &lt;a href=&#34;https://ms.tmail.io/stats&#34;&gt;https://ms.tmail.io/stats&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;parametres:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Paramètres&lt;/h3&gt;

&lt;p&gt;Les paramètres actuellement reconnus par tmail dans les URL sont:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;timeout&lt;/strong&gt; (default: 30): permet d&amp;rsquo;indiquer un timeout (en seconde) sur un appel. Par défaut il est de 30 secondes. Au dela de ce delais, tmail va considérer qu&amp;rsquo;il ne peut joindre le micro-service.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;onfailure&lt;/strong&gt; (default: continue): permet de spécifier une action si un appel échoue. Globalement un appel échoue si le timeout est déclenché ou si le code de retour HTTP indique une erreur (4xx ou 5xx).
Les valeurs possibles pour ce paramètre sont:

&lt;ul&gt;
&lt;li&gt;continue: On continue. Le traitement continue normalement.&lt;/li&gt;
&lt;li&gt;tempfail: Erreur temporaire: si une erreur à lieu pendant une transaction SMTP entrante, une erreur temporaire (4xx) est retournée au client. Si c&amp;rsquo;est pendant la livraison d&amp;rsquo;un mail ou lors d&amp;rsquo;une transaction sortante le mail est remis en queue et sera représenté.&lt;/li&gt;
&lt;li&gt;permfail: Erreur permanente: si une erreur à lieu pendant une transaction SMTP entrante une erreur permanente (5xx) est retournée au client. Si c&amp;rsquo;est pendant la livraison d&amp;rsquo;un mail ou lors d&amp;rsquo;une transaction sortante le mail est bouncé.&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;fireandforget&lt;/strong&gt; (default false): si ce paramètre est défini à &lt;strong&gt;true&lt;/strong&gt;, tmail va exécuter la requête dans un process parallèle et ne va pas tenir compte de la réponse. Autrement dit ce genre de traitement n&amp;rsquo;a aucune incidence sur le traitement réalisé par tmail. Attention cette option n&amp;rsquo;est pas disponible pour tous les hooks.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;protobuf:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Struture des messages échangés&lt;/h2&gt;

&lt;p&gt;Vous trouverez le fichier proto ici: &lt;a href=&#34;https://github.com/toorop/tmail/blob/master/msproto/proto/tmail.proto&#34; target=&#34;_blank&#34; title=&#34;tmail proto&#34;&gt; &lt;a href=&#34;https://github.com/toorop/tmail/blob/master/msproto/proto/tmail.proto&#34;&gt;https://github.com/toorop/tmail/blob/master/msproto/proto/tmail.proto&lt;/a&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Je ne peux que vous encourager à jeter un oeil sur ce fichier pour avoir un idée de la struture des messages et ce même si vous ne comptez pas developper de micro-services.&lt;/p&gt;

&lt;h2 id=&#34;hooks:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Étapes &amp;ldquo;hookables&amp;rdquo;&lt;/h2&gt;

&lt;p&gt;Voici la liste des points (hook) où il actuellement  possible d&amp;rsquo;étendre tmail avec pour chacun d&amp;rsquo;entre eux&lt;/p&gt;

&lt;h3 id=&#34;smtpdnewclient:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;SmtpdNewClient: Établissement d&amp;rsquo;une nouvelle connexion SMTP entrante&lt;/h3&gt;

&lt;p&gt;Le point d&amp;rsquo;entré dans la configuration est :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;TMAIL_MS_SMTPD_NEWCLIENT=&amp;quot;&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;structure-du-message-transmis-au-micro-service:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Structure du message transmis au micro service&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;message SmtpdNewClientMsg {
    required string session_id = 1;
    required string remote_ip = 2;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Avec:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;session_id&lt;/strong&gt; (requis): l&amp;rsquo;identifiant de la session SMTP qui traite cette transaction. Cet identifiant va être transmis dans tous les appels qui auront lieu durant une même transaction SMTP, il va donc permettre de suivre cette transaction, coté microservice, et de lier les requêtes.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;remote_ip&lt;/strong&gt; (requis): contient l&amp;rsquo;IP du client.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;structure-de-la-réponse-attendue-par-tmail:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Structure de la réponse attendue par tmail&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;message SmtpdNewClientResponse {
    required string session_id = 1;
    optional SmtpResponse smtp_response = 2;
    optional bool drop_connection = 3;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Avec:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;session_id&lt;/strong&gt;: l&amp;rsquo;identifiant de la session.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;smtp_response&lt;/strong&gt;: un message de type SmtpResponse qui va permettre de definir, si besoin, la réponse SMTP que tmail doit retourner au client. Vous n&amp;rsquo;avez pas à sytématiquement renseigner cette structure, faites le uniquement si vous avez besoin de retourner un message spécial au client et faite le en ayant bien conscience des conséquences. Vous trouverez la définition de cette structure un peu plus bas.&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;drop_connection&lt;/strong&gt;: un boolean qui si il est présent et positionné a &lt;em&gt;true&lt;/em&gt; va demander a tmail de terminer dés que possible la transaction. N&amp;rsquo;abusez pas de cette option, couper une transaction SMTP à l&amp;rsquo;initiative du serveur n&amp;rsquo;est pas trés RFC compliant.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Structure du message SmtpResponse:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;message SmtpResponse {
    required int32 code = 1;            // SMTP code (ignored if eq 0)
    required string msg = 2;            // SMTP message (ignored if eq &amp;quot;&amp;quot;)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Avec:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;code&lt;/strong&gt;: le code SMTP à retourner au client.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;msg&lt;/strong&gt;: le message à retourner au client.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Vous trouverez cette structure dans de nombreux hook smtpd.&lt;/p&gt;

&lt;h3 id=&#34;smtpdrcptto:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;SmtpdRcptto: Appelé après la commande SMTP RCPT TO&lt;/h3&gt;

&lt;p&gt;Le point d&amp;rsquo;entré dans la configuration est :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;export TMAIL_MS_SMTPD_RTCPTTO=&amp;quot;&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;structure-du-message-transmis-au-micro-service-1:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Structure du message transmis au micro service&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;message SmtpdRcptToQuery {
    required string session_id = 1;
    required string rcptto = 2;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Avec:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;rcptto&lt;/strong&gt; (requis): le rcptto sous forme d&amp;rsquo;adresse email.&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;structure-de-la-réponse-attendue-par-tmail-1:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Structure de la réponse attendue par tmail&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;message SmtpdRcptToResponse {
    required string session_id = 1;
    optional SmtpResponse smtp_response = 2;
    optional bool drop_connection = 3;
    optional bool relay_granted = 4;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Avec:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;relay_granted&lt;/strong&gt;: si renseignée permet d&amp;rsquo;authoriser ou pas le relai pour ce destinataire.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;smtpddata:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;SmtpdData: Après la commande SMTP DATA&lt;/h3&gt;

&lt;p&gt;Le point d&amp;rsquo;entré dans la configuration est :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;export TMAIL_MS_SMTPD_DATA=&amp;quot;&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;structure-du-message-transmis-au-micro-service-2:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Structure du message transmis au micro service&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;message SmtpdDataQuery {
    required string session_id = 1;
    required string data_link = 2;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Avec:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;data_link&lt;/strong&gt; (requis): Un lien HTTP depuis lequel le micro-service pourra télécharger le mail transmis à tmail lors de la commande DATA.&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;structure-de-la-réponse-attendue-par-tmail-2:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Structure de la réponse attendue par tmail&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;message SmtpdDataResponse {
    required string session_id = 1;
    optional SmtpResponse smtp_response = 2;
    optional string data_link = 3;
    optional bool drop_connection = 4;
    repeated string extra_headers = 5;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Avec:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;data_link&lt;/strong&gt; (optionnel): POas utilisé pour le moment&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;extra_headers&lt;/strong&gt; (optionnel): d&amp;rsquo;éventuels headers à ajouter.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;deliverdgetroutes:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;DeliverdGetRoutes: Appelé par deliverd pour obtenir le routage d&amp;rsquo;un mail&lt;/h3&gt;

&lt;p&gt;Ce &lt;em&gt;hook&lt;/em&gt; va vous permettre de faire du routage dynamique, d&amp;rsquo;adapter la route que doit prendre un message à un instant t en fonction de paramètres qui vous sont propres.&lt;/p&gt;

&lt;p&gt;Le point d&amp;rsquo;entré dans la configuration est :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;export TMAIL_MS_DELIVERD_GET_ROUTES=&amp;quot;&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;structure-du-message-transmis-au-micro-service-3:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Structure du message transmis au micro service&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;message DeliverdGetRoutesQuery {
    required string deliverd_id = 1;
    required string mailfrom = 2;
    required string rcptto =  3;
    required string authentified_user = 4;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Avec:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;deliverd_id&lt;/strong&gt;: l&amp;rsquo;identifiant unique du process deliverd.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;mailfrom&lt;/strong&gt;: l&amp;rsquo;adresse email de l&amp;rsquo;expéditeur.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;rcptto&lt;/strong&gt;: l&amp;rsquo;adresse email du destinataire.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;authentified_user&lt;/strong&gt;: si l&amp;rsquo;utilisateur qui a transmis le mail via SMTP s&amp;rsquo;est authentifié, alors cette variable contient son login.&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;structure-de-la-réponse-attendue-par-tmail-3:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Structure de la réponse attendue par tmail&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;message DeliverdGetRoutesResponse {
    message Route {
        required string remote_host = 1;
        required int64 remote_port = 2;
        optional string local_ip = 3;
        optional int32 priority = 4;
        optional string smtpauth_login = 5;
        optional string smtpauth_password = 6;
    }
    required string deliverd_id = 1;
    repeated Route routes = 2;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Avec:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;deliverd_id&lt;/strong&gt;: l&amp;rsquo;identifiant unique correspondant au process deliverd (transmis par tmail lors de la requète)&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;routes&lt;/strong&gt;: la ou les routes à utiliser pour ce mail.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Voici les définitions de la structure &lt;em&gt;Routes&lt;/em&gt;:
* &lt;strong&gt;remote_host&lt;/strong&gt;: L&amp;rsquo;adresse IP ou le nom d&amp;rsquo;hôte du serveur à qui tmail doit transmettre le mail.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;remote_port&lt;/strong&gt;: le port du serveur vers qui tmail doit transmettre le mail.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;local_ip&lt;/strong&gt;: l&amp;rsquo;adresse IP locale que tmail doit utiliser pour établir la connexion.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;priority&lt;/strong&gt;: la priorité de cette route. Plus le chiffre est petit plus la priorité est élevée. Dans le cas où plusieurs routes auraient la même priorité, elles seront sélectionnée aléatoirement par tmail, ce qui permet de faire simplement du round-robin.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;smtpauth_login&lt;/strong&gt;: si le serveur distant requière une authentification, cette variable permet de renseigner le login.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;smtpaut_passwd&lt;/strong&gt;: si le serveur distant requière une authentification, cette variable permet de renseigner le mot de passe.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;exempleimpl:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Exemples d&amp;rsquo;implémentation&lt;/h2&gt;

&lt;p&gt;Vous trouverez sur &lt;a href=&#34;https://github.com/toorop/tmail-ms-server&#34;&gt;https://github.com/toorop/tmail-ms-server&lt;/a&gt; différent exemples de micro-services pour tmail.
N&amp;rsquo;hésitez pas à participer à ce repo en proposant vos propres exemples. Si vous souhaitez publier un exemple dans un langage qui n&amp;rsquo;a pas encore de dossier spécifique, créez le à la racine du repo.&lt;/p&gt;

&lt;h2 id=&#34;msas:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;μsas: Micro-Services As Services&lt;/h2&gt;

&lt;p&gt;Un des autres intérêts de cette architecture est qu&amp;rsquo;il est possible de proposer des &lt;strong&gt;micro-services as service&lt;/strong&gt;, autrement dit de mettre à dispositions des utilisateurs de tmail des micro-services que l&amp;rsquo;on a codé et que l&amp;rsquo;on héberge.&lt;/p&gt;

&lt;p&gt;C&amp;rsquo;est ce que je vous propose ici, l&amp;rsquo;usage en est totalement libre et gratuit.&lt;/p&gt;

&lt;p&gt;Le code de ses micro-services est disponible ici: &lt;a href=&#34;https://github.com/toorop/tmail-ms-server/tree/master/golang/ms.tmail.io&#34;&gt;https://github.com/toorop/tmail-ms-server/tree/master/golang/ms.tmail.io&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;greysmtpd:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;SMTPD_NEWCLIENT: GreySmtpd&lt;/h3&gt;

&lt;p&gt;&lt;strong&gt;URL:&lt;/strong&gt; &lt;a href=&#34;https://ms.tmail.io/smtpdnewclientgreysmtpd&#34;&gt;https://ms.tmail.io/smtpdnewclientgreysmtpd&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Ce service va accepter ou refuser temporairement la connexion en fonction de la réputation de l&amp;rsquo;IP du client.&lt;/p&gt;

&lt;p&gt;Un client SMTP légitime va tenter à plusieurs reprises de transmettre un mail en cas d&amp;rsquo;échec des tentatives précédentes (si le serveur à retourné une erreur temporaire), l&amp;rsquo;idée ici est donc d&amp;rsquo;exploiter cette fonctionnalité pour écarter un maximum de spambot.&lt;/p&gt;

&lt;p&gt;Actuellement l&amp;rsquo;implémentation est la suivante:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Si une IP est suspecte (pas de reverse || listée sur spamcop):

&lt;ul&gt;
&lt;li&gt;Si elle n&amp;rsquo;est pas connue du micro-service, ou si elle est connue depuis moins de 2 heures, une erreur temporaire est retournée.&lt;/li&gt;
&lt;li&gt;Si elle est connue depuis plus de 3 heures et moins de 24 heures, on continue.&lt;/li&gt;
&lt;li&gt;Si elle connue depuis plus de 24 heures, l&amp;rsquo;horodatage est réinitialisé, le micro-service l&amp;rsquo;oubli, et une erreur temporaire est retournée.&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;dkimverif:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;SMTPD_DATA: DKIM verification&lt;/h3&gt;

&lt;p&gt;&lt;strong&gt;URL:&lt;/strong&gt; &lt;a href=&#34;https://ms.tmail.io/smtpddatadkimverif&#34;&gt;https://ms.tmail.io/smtpddatadkimverif&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Ce micro-service va vérifier la signature DKIM du mail, si le mail en a une, et va ajouter un header Authentication-Results.&lt;/p&gt;

&lt;p&gt;Par exemple en cas de succès:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Authentication-Results: dkim=success
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;En cas d&amp;rsquo;échec:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Authentication-Results: dkim=permfail testing body hash did not verify
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>Utilisez l&#39;API REST</title>
      <link>http://tmail.io/doc/api-rest/</link>
      <pubDate>Thu, 02 Apr 2015 11:14:47 +0200</pubDate>
      
      <guid>http://tmail.io/doc/api-rest/</guid>
      <description>

&lt;p&gt;Vous trouverez dans ce document toutes les informations nécessaires pour utiliser l&amp;rsquo;API REST tmail.&lt;/p&gt;

&lt;h2 id=&#34;sommaire:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Sommaire&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#authentification:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Authentification&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#requetes:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Requêtes&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#http_code:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Codes HTTP&lt;/a&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;a href=&#34;#erreurs:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Erreurs&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;a href=&#34;#users:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Gestion des utilisateurs&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#usersAdd:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Ajouter un utilisateur&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#usersDel:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Supprimer un utilisateur&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#usersGetOne:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Retrouver un utilisateur&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#usersGetAll:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Retrouver tous les utilisateurs&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;a href=&#34;#queue:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Gestion de la queue&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#queueListMessages:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Lister les messages en queue&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#queueGetMessage:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Récuperer les information concernant un message&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#queueDiscardMessage:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Supprimer un message&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#queueBounceMessage:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Bouncer un message&lt;/a&gt;&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;authentification:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Authentification&lt;/h3&gt;

&lt;p&gt;L&amp;rsquo;API utilise l&amp;rsquo;authentification &lt;a href=&#34;http://fr.wikipedia.org/wiki/Authentification_HTTP#M.C3.A9thode_.C2.AB_Basic_.C2.BB&#34; target=&#34;_blank&#34;&gt;HTTP Basic&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Pourquoi ce type d’authentification ?&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;simple à mettre en œuvre&lt;/li&gt;
&lt;li&gt;compatible avec tous les clients HTTP&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Exemple avec curl:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -v -u admin:admin -k https://127.0.0.1:8080/users/toorop@tmail.io
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;requetes:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Requêtes&lt;/h3&gt;

&lt;p&gt;Si il est nécessaire de transmettre des éléments à l&amp;rsquo;API (donc via POST, PUT ou PATCH), ils devront êtres encodés au format JSON.&lt;/p&gt;

&lt;h3 id=&#34;reponses:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Réponses&lt;/h3&gt;

&lt;p&gt;Le corps, si il existe est lui aussi un message JSON.&lt;/p&gt;

&lt;h3 id=&#34;http_code:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Codes HTTP&lt;/h3&gt;

&lt;p&gt;Succès :&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;200 OK: La requête à été exécuté avec succès, la réponse contient un corps.&lt;/li&gt;
&lt;li&gt;201 Created: L&amp;rsquo;entité à été crée.&lt;/li&gt;
&lt;li&gt;204 No Content: La requête à été exécuté avec succès, le corps de la réponse est vide.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Erreurs :&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;400 Bad Request: Le requête est mal formée.&lt;/li&gt;
&lt;li&gt;401 Unauthorized: Une autorisation est nécessaire.&lt;/li&gt;
&lt;li&gt;403 Forbidden: L’accès est refusé.&lt;/li&gt;
&lt;li&gt;404 Not Found: La ressource demandée n&amp;rsquo;existe pas.&lt;/li&gt;
&lt;li&gt;422 Unprocessable Entry: La requête visant à créer ou modifier une entité n&amp;rsquo;a pas pu être exécutée car les données transmises n&amp;rsquo;étaient pas conformes.&lt;/li&gt;
&lt;li&gt;500, 501, 502, 503, etc: Une erreur à eu lieu au niveau du serveur.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;erreurs:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Erreurs&lt;/h3&gt;

&lt;p&gt;En cas d&amp;rsquo;erreur (4** ou 5**), un message sous forme d&amp;rsquo;un objet JSON est retourné.
Le message contient deux champs:
* msg: le message d&amp;rsquo;erreur générée par l&amp;rsquo;application
* raw: l&amp;rsquo;erreur levée (quand elle existe)&lt;/p&gt;

&lt;p&gt;Exemple, si on essaye de créer un utilisateur qui existe déjà:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -H &amp;quot;Content-Type: application/json&amp;quot; -X POST -d &#39;{&amp;quot;passwd&amp;quot;:&amp;quot;motdepasse&amp;quot;,&amp;quot;authRelay&amp;quot;:true,&amp;quot;haveMailbox&amp;quot;:true,&amp;quot;mailboxQuota&amp;quot;:&amp;quot;1G&amp;quot;}&#39; -u admin:admin -k https://127.0.0.1:8080/users/toorop@tmail.io

&amp;lt; HTTP/1.1 422 status code 422
&amp;lt; Content-Type: application/json; charset=UTF-8
&amp;lt; Date: Wed, 01 Apr 2015 15:01:21 GMT
&amp;lt; Content-Length: 85

{&amp;quot;msg&amp;quot;:&amp;quot;unable to create new user&amp;quot;,&amp;quot;raw&amp;quot;:&amp;quot;UNIQUE constraint failed: users.login&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;users:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Gestion des utilisateurs&lt;/h2&gt;

&lt;h3 id=&#34;usersAdd:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Ajouter un utilisateur&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Ressource: /users/LOGIN&lt;/li&gt;
&lt;li&gt;Méthode: POST&lt;/li&gt;
&lt;li&gt;Body:

&lt;ul&gt;
&lt;li&gt;passwd (string): mot de passe de l&amp;rsquo;utilisateur.&lt;/li&gt;
&lt;li&gt;authRelay (bool): défini si l&amp;rsquo;utilisateur peut utiliser tmail pour relayer.&lt;/li&gt;
&lt;li&gt;haveMailbox (bool): défini si l&amp;rsquo;utilisateur à une boite email.&lt;/li&gt;
&lt;li&gt;mailboxQuota (string): le quota de la boite email de l&amp;rsquo;utilisateur en bytes. Vous pouvez utiliser K, M, ou G pour fénir les unités (par exemple 1G signifie un GB)&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Exemple:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -v -u admin:admin -k -H &amp;quot;Content-Type: application/json&amp;quot; -X POST -d &#39;{&amp;quot;passwd&amp;quot;: &amp;quot;mot de passe&amp;quot;, &amp;quot;authRelay&amp;quot;: true, &amp;quot;haveMailbox&amp;quot;: true, &amp;quot;mailboxQuota&amp;quot;: &amp;quot;1G&amp;quot;}&#39; https://127.0.0.1:8080/users/test@tmail.io

&amp;lt; HTTP/1.1 201 Created
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;usersDel:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Supprimer un utilisateur&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Ressource: /users/LOGIN&lt;/li&gt;
&lt;li&gt;Méthode: DELETE&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Exemple:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -v -u admin:admin -k  -X DELETE https://127.0.0.1:8080/users/test@tmail.io

&amp;lt; HTTP/1.1 200 OK
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;usersGetOne:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Retrouver un utilisateur&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Ressource: /users/LOGIN&lt;/li&gt;
&lt;li&gt;Méthode: GET&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Exemple:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -v -u admin:admin -k https://127.0.0.1:8080/users/test@tmail.io

&amp;lt; HTTP/1.1 200 OK
&amp;lt; Content-Type: application/json; charset=UTF-8

{&amp;quot;Id&amp;quot;:10,&amp;quot;Login&amp;quot;:&amp;quot;test@tmail.io&amp;quot;,&amp;quot;Passwd&amp;quot;:&amp;quot;$2a$10$TGg8af6X08KFvWDnjljAqeBpwkXuQ78sc.xyTUrHN6nRzm1wMyIT.&amp;quot;,&amp;quot;DovePasswd&amp;quot;:&amp;quot;$6$06a585cd9d0540d2$OYGaBsyonWxeuoRQkxsokLRkW/vUtx1qbZoEC1DG9DcX7NmHqgrqQtIuL0N6r0RuPpOOhgMdiXPYr/0Dg.wA41&amp;quot;,&amp;quot;Active&amp;quot;:&amp;quot;Y&amp;quot;,&amp;quot;AuthRelay&amp;quot;:true,&amp;quot;HaveMailbox&amp;quot;:true,&amp;quot;MailboxQuota&amp;quot;:&amp;quot;1G&amp;quot;,&amp;quot;Home&amp;quot;:&amp;quot;/home/toorop/Projects/Go/src/github.com/toorop/tmail/dist/mailboxes/t/tmail.io/t/test&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;usersGetAll:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Retrouver tous les utilisateurs&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Ressource: /users&lt;/li&gt;
&lt;li&gt;Méthode: GET&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Exemple:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -v -u admin:admin -k https://127.0.0.1:8080/users

&amp;lt; HTTP/1.1 200 OK
&amp;lt; Content-Type: application/json; charset=UTF-8

[{&amp;quot;Id&amp;quot;:4,&amp;quot;Login&amp;quot;:&amp;quot;texset@tmail.io&amp;quot;,&amp;quot;Passwd&amp;quot;:&amp;quot;$2a$10$rih8MngreLiYl6KzB72jVuufgtIHYFF08c4Q.GNIx2UObPOrL18QW&amp;quot;,&amp;quot;DovePasswd&amp;quot;:&amp;quot;$6$ba3b4fb33607b031$5.FuzhmYBHK5fBIGSMamG7nv7G/OfHxGBuGPBkfSU0FiE6AvWAJIplz/RJP5AQoTFrKC.vYulBeKlKm/Ua7Gj.&amp;quot;,&amp;quot;Active&amp;quot;:&amp;quot;Y&amp;quot;,&amp;quot;AuthRelay&amp;quot;:false,&amp;quot;HaveMailbox&amp;quot;:false,&amp;quot;MailboxQuota&amp;quot;:&amp;quot;&amp;quot;,&amp;quot;Home&amp;quot;:&amp;quot;&amp;quot;},{&amp;quot;Id&amp;quot;:5,&amp;quot;Login&amp;quot;:&amp;quot;texsdet@tmail.io&amp;quot;,&amp;quot;Passwd&amp;quot;:&amp;quot;$2a$10$Lnvy5ViilsKwAKKLsxhrZOhlcZkW.gbDvffEpyEif6Fefc5NU0iOe&amp;quot;,&amp;quot;DovePasswd&amp;quot;:&amp;quot;$6$8c69e981ea71fa91$WRbtGb6AnEKQo.wSRd2VecOkjiHKCr/SVK0ww.qqK/O.wAjLNUn6ztEpONycwFYwiLWU82rI52A8rLzqrNsE./&amp;quot;,&amp;quot;Active&amp;quot;:&amp;quot;Y&amp;quot;,&amp;quot;AuthRelay&amp;quot;:false,&amp;quot;HaveMailbox&amp;quot;:false,&amp;quot;MailboxQuota&amp;quot;:&amp;quot;&amp;quot;,&amp;quot;Home&amp;quot;:&amp;quot;&amp;quot;}]
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;queue:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Gestion de la queue&lt;/h2&gt;

&lt;h3 id=&#34;queueListMessages:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Lister les messages en queue&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Ressource: /queue&lt;/li&gt;
&lt;li&gt;Méthode: GET&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Exemple:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -v -u admin:admin -k https://127.0.0.1:8080/queue

&amp;lt; HTTP/1.1 200 OK
&amp;lt; Content-Type: application/json; charset=UTF-8

[{&amp;quot;Id&amp;quot;:1,&amp;quot;Uuid&amp;quot;:&amp;quot;5217dfdc96d7216d7074b329f88d11f76dee997b&amp;quot;,&amp;quot;Key&amp;quot;:&amp;quot;84855041283d1badc5224231b2afa57f6e1b12e2&amp;quot;,&amp;quot;MailFrom&amp;quot;:&amp;quot;toorop@tmail.io&amp;quot;,&amp;quot;AuthUser&amp;quot;:&amp;quot;toorop@tmail.io&amp;quot;,&amp;quot;RcptTo&amp;quot;:&amp;quot;toorop@toorop.fr&amp;quot;,&amp;quot;MessageId&amp;quot;:&amp;quot;5528C725.8060007@tmail.io&amp;quot;,&amp;quot;Host&amp;quot;:&amp;quot;toorop.fr&amp;quot;,&amp;quot;AddedAt&amp;quot;:&amp;quot;2015-04-11T09:03:02.737629459+02:00&amp;quot;,&amp;quot;NextDeliveryScheduledAt&amp;quot;:&amp;quot;2015-04-11T16:44:35.994411773+02:00&amp;quot;,&amp;quot;Status&amp;quot;:2,&amp;quot;DeliveryFailedCount&amp;quot;:0},{&amp;quot;Id&amp;quot;:2,&amp;quot;Uuid&amp;quot;:&amp;quot;bd36f47dab0e27482ce5db8605415e32978f0185&amp;quot;,&amp;quot;Key&amp;quot;:&amp;quot;38b27d32311b21f1e6afa6215a756c8f696979a8&amp;quot;,&amp;quot;MailFrom&amp;quot;:&amp;quot;toorop@tmail.io&amp;quot;,&amp;quot;AuthUser&amp;quot;:&amp;quot;toorop@tmail.io&amp;quot;,&amp;quot;RcptTo&amp;quot;:&amp;quot;stephane@protecmail.com&amp;quot;,&amp;quot;MessageId&amp;quot;:&amp;quot;5529331C.3050308@tmail.io&amp;quot;,&amp;quot;Host&amp;quot;:&amp;quot;protecmail.com&amp;quot;,&amp;quot;AddedAt&amp;quot;:&amp;quot;2015-04-11T16:43:41.965596115+02:00&amp;quot;,&amp;quot;NextDeliveryScheduledAt&amp;quot;:&amp;quot;0001-01-01T00:09:21+00:09&amp;quot;,&amp;quot;Status&amp;quot;:0,&amp;quot;DeliveryFailedCount&amp;quot;:0}]
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;queueGetMessage:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Récuperer les information concernant un message&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Ressource: /queue/ID&lt;/li&gt;
&lt;li&gt;Méthode: GET&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Exemple:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -v -u admin:admin -k https://127.0.0.1:8080/queue/1

&amp;lt; HTTP/1.1 200 OK
&amp;lt; Content-Type: application/json; charset=UTF-8

{&amp;quot;Id&amp;quot;:1,&amp;quot;Uuid&amp;quot;:&amp;quot;5217dfdc96d7216d7074b329f88d11f76dee997b&amp;quot;,&amp;quot;Key&amp;quot;:&amp;quot;84855041283d1badc5224231b2afa57f6e1b12e2&amp;quot;,&amp;quot;MailFrom&amp;quot;:&amp;quot;toorop@tmail.io&amp;quot;,&amp;quot;AuthUser&amp;quot;:&amp;quot;toorop@tmail.io&amp;quot;,&amp;quot;RcptTo&amp;quot;:&amp;quot;toorop@toorop.fr&amp;quot;,&amp;quot;MessageId&amp;quot;:&amp;quot;5528C725.8060007@tmail.io&amp;quot;,&amp;quot;Host&amp;quot;:&amp;quot;toorop.fr&amp;quot;,&amp;quot;AddedAt&amp;quot;:&amp;quot;2015-04-11T09:03:02.737629459+02:00&amp;quot;,&amp;quot;NextDeliveryScheduledAt&amp;quot;:&amp;quot;2015-04-11T17:15:36.290267337+02:00&amp;quot;,&amp;quot;Status&amp;quot;:2,&amp;quot;DeliveryFailedCount&amp;quot;:0}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;queueDiscardMessage:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Supprimer un message&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Ressource: /queue/discard/ID&lt;/li&gt;
&lt;li&gt;Méthode: DELETE&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Exemple:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -v -u admin:admin -X DELETE -k https://127.0.0.1:8080/queue/discard/1

&amp;lt; HTTP/1.1 200 OK
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;queueBounceMessage:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Bouncer un message&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Ressource: /queue/bounce/ID&lt;/li&gt;
&lt;li&gt;Méthode: DELETE&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Exemple:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -v -u admin:admin -X DELETE -k https://127.0.0.1:8080/queue/bounce/1

&amp;lt; HTTP/1.1 200 OK
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>Activer l&#39;API REST</title>
      <link>http://tmail.io/doc/activer-api-rest/</link>
      <pubDate>Wed, 01 Apr 2015 15:05:07 +0200</pubDate>
      
      <guid>http://tmail.io/doc/activer-api-rest/</guid>
      <description>

&lt;p&gt;tmail embarque un &lt;a href=&#34;http://fr.wikipedia.org/wiki/Serveur_HTTP&#34; target=&#34;_blank&#34; title=&#34;qu&#39;est ce qu&#39;un serveur HTTP&#34;&gt; serveur HTTP&lt;/a&gt; qui expose une &lt;a href=&#34;http://fr.wikipedia.org/wiki/Representational_State_Transfer&#34; target=&#34;_blank&#34; title=&#34;Qu&#39;est ce qu&#39;une API REST&#34;&gt;API REST&lt;/a&gt;. Cette API vous permet d’administrer votre serveur tmail et &lt;em&gt;&amp;lt;teasing&amp;gt;&lt;/em&gt; dans un futur &amp;ldquo;proche&amp;rdquo; votre cluster SMTP tmail&lt;em&gt;&amp;lt;/teasing&amp;gt;&lt;/em&gt;.&lt;/p&gt;

&lt;h3 id=&#34;activation-et-configuration-de-l-api-rest:82051207c90b1bf3c7ca93b8129f63c7&#34;&gt;Activation et configuration de l&amp;rsquo;API REST.&lt;/h3&gt;

&lt;p&gt;Vous devez d&amp;rsquo;abord spécifier que vous souhaitez activer le service:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Launch REST server
export TMAIL_REST_SERVER_LAUNCH=true
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Puis définir sur quelle IP il doit écouter:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# REST server IP
export TMAIL_REST_SERVER_IP=&amp;quot;127.0.0.1&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Et sur quel port:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# REST server port
export TMAIL_REST_SERVER_PORT=8080
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Ce paramètre vous permet d&amp;rsquo;activer (ou non) le chiffrement de votre connexion:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# REST server is TLS (https) ?
export TMAIL_REST_SERVER_IS_TLS=true
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;tmail va utiliser le certificat dist/ssl/web_server.crt et la clé dist/ssl/web_server.key pour chiffrer les transactions. Vous pouvez utiliser ceux inclus dans la distribution pour vos tests mais attention cela va générer des alertes auprès des clients REST que vous allez utiliser.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Si votre serveur REST écoute sur une IP publique, activer TLS n&amp;rsquo;est pas une option, c&amp;rsquo;est impératif car l&amp;rsquo;authentification se fait avec des mots de passe en clair  &lt;a href=&#34;http://fr.wikipedia.org/wiki/Authentification_HTTP#M.C3.A9thode_.C2.AB_Basic_.C2.BB&#34; target=&#34;_blank&#34;&gt;(authentification HTTP Basic)&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Enfin vous devez définir vos identifiants de connexion:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Login for HTTP auth
export TMAIL_REST_SERVER_LOGIN=&amp;quot;admin&amp;quot;

# Passwd for HTTP auth
export TMAIL_REST_SERVER_PASSWD=&amp;quot;admin&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;test:82051207c90b1bf3c7ca93b8129f63c7&#34;&gt;Test&lt;/h4&gt;

&lt;p&gt;Après avoir relancé tmail vous devriez voir dans vos logs une ligne de ce type:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[trooper - 127.0.0.1] 2015/04/01 15:32:06.467484 INFO - httpd 127.0.0.1:8080 TLS launched
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Vous pouvez tester le fonctionnement de l&amp;rsquo;API en appelant la ressource /ping. Par exemple avec &lt;a href=&#34;http://curl.haxx.se/&#34; target=&#34;_blank&#34; title=&#34;tester une API REST avec curl&#34;&gt;curl&lt;/a&gt; :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ curl -k https://127.0.0.1:8080/ping
{&amp;quot;msg&amp;quot;: &amp;quot;pong&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;La ligne de log correspondant à cette requête :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[trooper - 127.0.0.1] 2015/04/02 11:09:51.647899 INFO - http 127.0.0.1:54423 - GET /ping - 200 OK 4.638µs
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;em&gt;Note: Non il n&amp;rsquo;y à pas d&amp;rsquo;erreur la requête à bien mis 0.000004 seconde pour être exécutée ;-)&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&#34;généralités:82051207c90b1bf3c7ca93b8129f63c7&#34;&gt;Généralités&lt;/h2&gt;

&lt;h3 id=&#34;authentification:82051207c90b1bf3c7ca93b8129f63c7&#34;&gt;Authentification&lt;/h3&gt;

&lt;p&gt;L&amp;rsquo;API utilise l&amp;rsquo;authentification &lt;a href=&#34;http://fr.wikipedia.org/wiki/Authentification_HTTP#M.C3.A9thode_.C2.AB_Basic_.C2.BB&#34; target=&#34;_blank&#34;&gt;HTTP Basic&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Pourquoi ce type d’authentification ?&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;simple à mettre en œuvre&lt;/li&gt;
&lt;li&gt;compatible avec tous les clients HTTP&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;requêtes:82051207c90b1bf3c7ca93b8129f63c7&#34;&gt;Requêtes&lt;/h3&gt;

&lt;p&gt;Si il est nécessaire de transmettre des éléments à l&amp;rsquo;API (donc via POST, PUT ou PATCH), ils devront êtres encodés au format JSON.&lt;/p&gt;

&lt;h3 id=&#34;réponses:82051207c90b1bf3c7ca93b8129f63c7&#34;&gt;Réponses&lt;/h3&gt;

&lt;p&gt;Le corps, si il existe est lui aussi un message JSON.&lt;/p&gt;

&lt;h3 id=&#34;codes-http:82051207c90b1bf3c7ca93b8129f63c7&#34;&gt;Codes HTTP&lt;/h3&gt;

&lt;p&gt;Succès :&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;200 OK: La requête à été exécuté avec succès, la réponse contient un corps.&lt;/li&gt;
&lt;li&gt;201 Created: L&amp;rsquo;entité à été crée.&lt;/li&gt;
&lt;li&gt;204 No Content: La requête à été exécuté avec succès, le corps de la réponse est vide.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Erreurs :&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;400 Bad Request: Le requête est mal formée.&lt;/li&gt;
&lt;li&gt;401 Unauthorized: Une autorisation est nécessaire.&lt;/li&gt;
&lt;li&gt;403 Forbidden: L’accès est refusé.&lt;/li&gt;
&lt;li&gt;404 Not Found: La ressource demandée n&amp;rsquo;existe pas.&lt;/li&gt;
&lt;li&gt;422 Unprocessable Entry: La requête visant à créer ou modifier une entité n&amp;rsquo;a pas pu être exécutée car les données transmises n&amp;rsquo;étaient pas conformes.&lt;/li&gt;
&lt;li&gt;500, 501, 502, 503, etc: Une erreur à eu lieu au niveau du serveur.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;erreurs:82051207c90b1bf3c7ca93b8129f63c7&#34;&gt;Erreurs&lt;/h3&gt;

&lt;p&gt;En cas d&amp;rsquo;erreur (4** ou 5**), un message sous forme d&amp;rsquo;un objet JSON est retourné.
Le message contient deux champs:
* msg: le message d&amp;rsquo;erreur générée par l&amp;rsquo;application
* raw: l&amp;rsquo;erreur levée (quand elle existe)&lt;/p&gt;

&lt;p&gt;Exemple, si on essaye de créer un utilisateur qui existe déjà:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -H &amp;quot;Content-Type: application/json&amp;quot; -X POST -d &#39;{&amp;quot;passwd&amp;quot;:&amp;quot;motdepasse&amp;quot;,&amp;quot;authRelay&amp;quot;:true,&amp;quot;haveMailbox&amp;quot;:true,&amp;quot;mailboxQuota&amp;quot;:&amp;quot;1G&amp;quot;}&#39; -u admin:admin -k https://127.0.0.1:8080/users/toorop@tmail.io

&amp;lt; HTTP/1.1 422 status code 422
&amp;lt; Content-Type: application/json; charset=UTF-8
&amp;lt; Date: Wed, 01 Apr 2015 15:01:21 GMT
&amp;lt; Content-Length: 85

{&amp;quot;msg&amp;quot;:&amp;quot;unable to create new user&amp;quot;,&amp;quot;raw&amp;quot;:&amp;quot;UNIQUE constraint failed: users.login&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
  </channel>
</rss>