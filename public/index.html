<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title> tmail &middot; tmail </title>

  
  <link rel="stylesheet" href="http://tmail.io/css/poole.css">
  <link rel="stylesheet" href="http://tmail.io/css/syntax.css">
  <link rel="stylesheet" href="http://tmail.io/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.ico">

  
  <link href="http://tmail.io/index.xml" rel="alternate" type="application/rss+xml" title="tmail" />
</head>

<body>

<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>tmail</h1>
      <p class="lead">
       devblog 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="/">Home</a> </li>
      
        <li><a href="http://tmail.io/faq/"> FAQ </a></li>
      
      <li><a href="mailto:toorop@toorop.fr"> Contact </a></li>
    </ul>

    
  </div>
</div>


    <div class="content container">
<div class="posts">

      
  <div class="post">
    <h1 class="post-title">
      <a href="http://tmail.io/doc/installer-tmail/">
        Installer et configurer tmail
      </a>
    </h1>

    <span class="post-date">Thu, Jan 29, 2015</span>

    

<p>Durant tout le cycle de développement de tmail je vais mettre à disposition le nécessaire pour qu&rsquo;il soit possible de tester les fonctionnalités qui sont implémentées.</p>

<p>Qu&rsquo;il n&rsquo;y ait pas de malentendu, on ne parle pas ici de version bêta, ni même alpha, ce sera à chaque fois une version de développement, avec plein de choses non implémentées et forcement de nombreux bugs.</p>

<p><strong>En clair: ne pas utiliser en production</strong></p>

<p>Pour le moment tmail est très basique, mais il devrait cependant vous permettre d&rsquo;envoyer et de relayer des mails.</p>

<p>On va partir sur une installation qui va nous permettre de mettre en place un service SMTP qui va:</p>

<ul>
<li>écouter sur les ports 25 et 587 (avec STARTTLS).</li>
<li>écouter sur le port 465 en SSL.</li>
<li>accepter tous les mails à destination du domaine <em>toorop.fr</em> et qui va les router vers <em>mail.toorop.fr</em></li>
<li>permettre à l&rsquo;utilisateur <em>toorop@toorop.fr</em> ayant comme mot de passe <em>password</em> d&rsquo;utiliser le service pour envoyer des mails (quelque soit la destination).</li>
</ul>

<h2 id="prérequis:b68dafd7755f74812ae92f74ce38ff42">Prérequis</h2>

<p>Pour le moment je ne fournis que le binaire Linux 32bits, vous n&rsquo;avez donc besoin de rien d&rsquo;autre pour tester qu&rsquo;une machine sous Linux. Pour cet exemple je vais utiliser un <a href="https://www.ovh.com/fr/vps/vps-classic.xml">VPS Classic 1 OVH</a> sous <em>Ubuntu server 64bits</em>.</p>

<p>Pensez à vous assurer que vous pouvez utiliser les ports SMTP (ou alors testez sur des ports alternatifs).</p>

<p>Si vous comptez utiliser tmail pour envoyer des mails, pensez à mettre un reverse sur l&rsquo;IP (ou les IP) de votre serveur.</p>

<p>Pensez aussi à renseigner les SPF des domaines que vous allez utiliser comme émetteurs le cas échéant.</p>

<p>A noter que comme backend pour la base de données vous pouvez utiliser sqlite, MySQl (et dérivés) ou Postgresql. Pour cette première phase je vous encourage chaudement à utiliser sqlite, ce sera amplement suffisant.</p>

<p>A terme, tmail sera splitté en composants sous forme de containers Docker, dans ce qui suit je vais juste expliquer l&rsquo;installation &ldquo;standalone&rdquo; (vs cluster).</p>

<h3 id="dependances-outils:b68dafd7755f74812ae92f74ce38ff42">Dependances &amp; outils</h3>

<p>tmail est un binaire statique, vous n&rsquo;avez besoin d&rsquo;aucune librairie spécifique.</p>

<p>Par contre votre serveur devra disposer des softs suivant:</p>

<ul>
<li>unzip: pour décrompresser l&rsquo;archive contenant le necessaire à la mise en place de tmail. Pour ceux qui se posent la question de savoir pourquoi j&rsquo;utilise la format zip plutot qu&rsquo;un format plus &ldquo;générique&rdquo; dans un environement *nix, la réponse est que tmail sera dispo sur plusieurs plateformes et du coup je préfére utiliser un format trés courant.</li>
</ul>

<p>Si vous etes sous Debian/Ubuntu:</p>

<pre><code>apt-get install unzip
</code></pre>

<h3 id="vous-avez-trouvé-un-bug:b68dafd7755f74812ae92f74ce38ff42">Vous avez trouvé un bug ?</h3>

<p>Utilisez le <a href="https://github.com/Toorop/tmail-bugtracker">bugtracker dédié sur Github</a></p>

<h3 id="discuter-du-projet:b68dafd7755f74812ae92f74ce38ff42">Discuter du projet</h3>

<p>J&rsquo;ai mis en place <a href="https://groups.google.com/d/forum/tmail-dev">un groupe de discutions</a> sur Google Groups pour discuter du projet. N&rsquo;hésitez pas à soumettre vos suggestions.</p>

<h3 id="note-sur-l-utilisation-des-ports-inférieurs-à-1024:b68dafd7755f74812ae92f74ce38ff42">Note sur l&rsquo;utilisation des ports inférieurs à 1024</h3>

<p>Sur un système linux un processus ne peut ouvrir un port inférieur à 1024 que si il est root.
Une des limitations de Go fait que l&rsquo;on ne peut pas lancer d&rsquo;application sous l&rsquo;utilisateur root pour ouvrir les ports nécessaires et ensuite <em>forker</em> sous un autre user.<br />
Il y à plusieurs autres solutions pour contourner ce problème, la plus simple à mettre en œuvre est d&rsquo;utiliser iptables. C&rsquo;est ce que nous allons faire ici.</p>

<h2 id="installation:b68dafd7755f74812ae92f74ce38ff42">Installation</h2>

<h3 id="ajout-de-l-utilisateur-tmail:b68dafd7755f74812ae92f74ce38ff42">Ajout de l&rsquo;utilisateur tmail</h3>

<p>On va commencer par ajouter un utilisateur tmail</p>

<pre><code>adduser tmail
</code></pre>

<h3 id="téléchargement-de-tmail:b68dafd7755f74812ae92f74ce38ff42">Téléchargement de tmail</h3>

<p>J&rsquo;ai mis sur mon FTP une archive comprenant le binaire et divers autre éléments utiles pour installer tmail.</p>

<p>On va donc commencer par récupérer cette archive et la décompresser.</p>

<pre><code># su tmail
$ cd
$ wget ftp://ftp.toorop.fr/softs/tmail/tmail.zip
$ unzip tmail.zip
$ cd dist
</code></pre>

<p>Le répertoire <em>dist</em> contient les éléments nécessaires pour lancer tmail:</p>

<pre><code>$ ls -la
drwxrwxr-x 5 tmail tmail     4096 févr.  2 09:08 .
drwxr-xr-x 3 tmail tmail     4096 févr.  2 09:08 ..
drwxrwxr-x 2 tmail tmail     4096 févr.  2 09:08 conf
-rw-rw-r-- 1 tmail tmail       38 janv. 16 15:14 run
drwx------ 2 tmail tmail     4096 déc.  29 12:02 ssl
-rwxr-xr-x 1 tmail tmail 14370520 janv. 28 16:34 tmail
drwxrwxr-x 2 tmail tmail     4096 déc.  29 11:20 tpl
</code></pre>

<p>Avant de vous détailler ces différents éléments, on va fixer quelques droits, (il se peut que ce ne soit pas toujours nécessaire mais dans tous les cas pensez à vérifier):</p>

<pre><code>chmod 700 run tmail 
</code></pre>

<p>et on va rajouter deux répertoires:</p>

<pre><code>mkdir db
mkdir store 
</code></pre>

<ul>
<li>conf: contient, oh surprise, le fichier de configuration.</li>
<li>run: est un mini script qui va charger la config et lancer tmail.</li>
<li>ssl: est le répertoire contenant le nécessaire pour gérer le SSL. Vous pouvez utiliser ce qui est inclus dans la distribution dans le cadre de tests mais pensez à créer vos propres certificat et clé en prod (si besoin je ferais un tuto).</li>
<li>tmail: est l&rsquo;exécutable.</li>
<li>tpl: contient des templates, par exemple pour les bounces.</li>
<li>db: contiendra la base sqlite (si vous utilisez sqlite&hellip;)</li>
<li>store: va servir au stockage des mails en queue. Vous pouvez le mettre ailleurs mais pensez à faire la modification dans le fichier de configuration. A terme, il va y avoir d&rsquo;autre type se <em>store</em> que du stockage sur le disque local.</li>
</ul>

<h2 id="configuration:b68dafd7755f74812ae92f74ce38ff42">Configuration</h2>

<p>On va commencer par copier le ficher tmail.cfg.base vers tmail.cfg car c&rsquo;est ce dernier qui sera pris en compte:</p>

<pre><code>cp tmail.cfg.base tmail.cfg
chmod 600 tmail.cfg 
</code></pre>

<p>Je ne vais parler que des options qu&rsquo;il va être nécessaire de modifier:</p>

<ul>
<li><p>TMAIL_ME: C&rsquo;est le nom d’hôte de votre serveur, celui qui va être utilisé, entre autre, dans la commande HELO/EHLO. Personnalisez cette valeur pour qu&rsquo;elle corresponde au reverse de votre IP.</p></li>

<li><p>TMAIL_DEBUG_ENABLED: si positionné à <em>true</em> vous allez avoir toutes les info de debug. Pour une sortie moins verbeuse mettez false, mais je ne vous le conseille pas dans le cadre de ces tests.</p></li>

<li><p>TMAIL_DB_DRIVER: la base de données utilisées. Notez que pour le moment j&rsquo;utilise exclusivement sqlite3, les autres devraient fonctionner mais je ne garantis rien.</p></li>

<li><p>TMAIL_DB_SOURCE: la source des données.</p></li>

<li><p>TMAIL_SMTPD_DSNS: cette option va nous permettre de définir les IP:port d&rsquo;écoute de tmail et si on doit activer SSL ou pas. A noter que si SSL n&rsquo;est pas activé on a tout de même l&rsquo;option ESMTP STARTTLS qui permet d&rsquo;avoir des transactions chiffrées si le client supporte STARTTLS.
Dans notre cas on veut que tmail écoute sur l&rsquo;IP publique du serveur 151.80.115.83, sur les port 25 et 587 et sur le port 465 en SSL. Comme l&rsquo;utilisateur tmail ne peut ouvrir ces ports on va utiliser 2525 5877 et 4655 et on fera de la redirection de port. On a donc:
TMAIL_SMTPD_DSNS=&ldquo;151.80.115.83:2525:false,151.80.115.83:5877:false,151.80.115.83:4655:true&rdquo;</p></li>

<li><p>TMAIL_DELIVERD_LOCAL_IPS: c&rsquo;est l&rsquo;IP (ou les IP) locale(s) à utiliser pour envoyer des mails. Pour ce premier test on va faire simple, on va utiliser une seule adresse, celle par défaut du serveur: export TMAIL_DELIVERD_LOCAL_IPS=&ldquo;151.80.115.83&rdquo;</p></li>

<li><p>TMAIL_DELIVERD_MAX_IN_FLIGHT: correspond au nombre de &ldquo;delivery&rdquo;, autrement dit d&rsquo;envois concurrents.</p></li>

<li><p>TMAIL_DELIVERD_QUEUE_LIFETIME: correspond au temps de rétention en queue avant qu&rsquo;un mail ne soit bouncé si tmail n&rsquo;arrive pas à l’expédier. Par défaut le temps est très court, si il vous prend l&rsquo;envie d&rsquo;utiliser tmail en prod (ce que je ne vous conseille pas de faire en l&rsquo;état) augmentez le.</p></li>
</ul>

<p>Un fois cette configuration faite, on peut lancer lancer tmail.</p>

<p>Vu que c&rsquo;est un premier lancement tmail va détecter que la base de données n&rsquo;est pas initialisée et il va vous demander si il peut le faire:</p>

<pre><code>tmail@dev:~/dist$ ./run 
Database 'driver: sqlite3, source: /home/tmail/dist/db/tmail.db' misses some tables.
Should i create them ? (y/n): y

je vous passe les info de debug..

[dev.tmail.io - 127.0.0.1] 2015/02/02 12:42:32.449597 INFO - smtpd 151.80.115.83:2525 launched.
[dev.tmail.io - 127.0.0.1] 2015/02/02 12:42:32.449931 INFO - smtpd 151.80.115.83:5877 launched.
[dev.tmail.io - 127.0.0.1] 2015/02/02 12:42:32.450011 INFO - smtpd 151.80.115.83:4655 SSL launched.
[dev.tmail.io - 127.0.0.1] 2015/02/02 12:42:32.499728 INFO - deliverd launched
</code></pre>

<h3 id="redirection-de-ports-via-iptables:b68dafd7755f74812ae92f74ce38ff42">Redirection de ports via iptables</h3>

<p>Pour que tmail écoute sur les ports standards nous allons mettre en place les trois règles suivantes. Attention assurez vous que vous n&rsquo;avez pas déjà un serveur SMTP qui écoute sur ces ports, si c&rsquo;est le cas et que vous ne souhaitez pas l’arrêter, utilisez simplement tmail sur les port alternatifs.</p>

<pre><code>iptables -t nat -A PREROUTING -p tcp --dport 25 -j REDIRECT --to-port 2525
iptables -t nat -A PREROUTING -p tcp --dport 465 -j REDIRECT --to-port 4655
iptables -t nat -A PREROUTING -p tcp --dport 587 -j REDIRECT --to-port 5877
</code></pre>

<h3 id="le-moment-est-venu-de-faire-un-premier-test:b68dafd7755f74812ae92f74ce38ff42">Le moment est venu de faire un premier test</h3>

<p>Vous pouvez faire le test depuis la même machine mais tant qu&rsquo;a faire, faites le depuis une autre.</p>

<pre><code>$ telnet dev.tmail.io 25
Trying 151.80.115.83...
Connected to dev.tmail.io.
Escape character is '^]'.
220 tmail.io  tmail ESMTP f22815e0988b8766b6fe69cbc73fb0d965754f60
HELO toto
250 tmail.io
MAIL FROM: toorop@toorop.fr
250 ok
RCPT TO: toorop@toorop.fr
554 5.7.1 &lt;toorop@toorop.fr&gt;: Relay access denied.
Connection closed by foreign host.
</code></pre>

<p>Parfait !
Pour le moment le mail est refusé car nous n&rsquo;avons défini aucune autorisation.</p>

<h3 id="prise-en-charge-des-mails-du-domaine-toorop-fr:b68dafd7755f74812ae92f74ce38ff42">Prise en charge des mails du domaine toorop.fr</h3>

<p>Pour que tmail prenne en charge les mails du domaine toorop.fr il suffit tout simplement deexécuter la commande suivante:</p>

<pre><code>tmail smtpd addRcpthost toorop.fr
</code></pre>

<p>Si vous avez une erreur du type:</p>

<pre><code>2015/02/02 15:51:30 unable to load config from env, TMAIL_ME variable is missing.
</code></pre>

<p>C&rsquo;est parce que la configuration n&rsquo;est pas chargée dans votre environnement, pour y remédier exécuter:</p>

<pre><code>. /home/tmail/dist/conf/tmail.cfg
</code></pre>

<p>Vérifions que tmail accepte les mails pour toorop.fr:</p>

<pre><code>$ telnet dev.tmail.io 25
Trying 151.80.115.83...
Connected to dev.tmail.io.
Escape character is '^]'.
220 tmail.io  tmail ESMTP 96b78ef8f850253cc956820a874e8ce40773bfb7
HELO toto
250 tmail.io
mail from: toorop@toorop.fr
250 ok
rcpt to: toorop@toorop.fr
250 ok
data
354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;
subject: test tmail

blabla
.
250 2.0.0 Ok: queued 2736698d73c044fd7f1994e76814d737c702a25e
quit
221 2.0.0 Bye
Connection closed by foreign host.
</code></pre>

<h3 id="router-les-mails-à-destination-du-domaine-toorop-fr-vers-mail-toorop-fr:b68dafd7755f74812ae92f74ce38ff42">Router les mails à destination du domaine toorop.fr vers mail.toorop.fr</h3>

<p>Par défaut quand tmail doit router un mail, il va utiliser les enregistrements DNS MX du domaine pour savoir à qui le transmettre. Mais nous pouvons aussi créer des routes &ldquo;en dur&rdquo;. Par exemple si nous souhaitons que tmail transmette les mails à destination du domaine toorop.fr au relais mail.toorop.fr il suffit de lui indiquer via cette commande :</p>

<pre><code>tmail routes add -d toorop.fr -rh mail.toorop.fr
</code></pre>

<p>Je vous invite lire la documentation sur les <a href="/doc/cli-gestion-route-smtp/">régles de routage SMTP</a> pour connaitre les possibilités offertes par tmail.</p>

<h3 id="ajout-de-utilisateur-smtp-toorop-toorop-fr:b68dafd7755f74812ae92f74ce38ff42">Ajout de utilisateur SMTP toorop@toorop.fr</h3>

<p>Si vous souhaitez ajouter un utilisateur <em>toorop@toorop.fr</em> qui pourra envoyer des mails via tmail en s&rsquo;authentifiant via SMTPAUTH avec le mot de passe <em>password</em>:</p>

<pre><code>tmail smtpd addUser toorop@toorop.fr password
</code></pre>

<p>Pour supprimer un utilisateur:</p>

<pre><code>tmail smtpd delUser toorop@toorop.fr
</code></pre>

<p>Bon tests ;)</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://tmail.io/doc/cli-gestion-route-smtp/">
        Gestion des routes SMTP en utilisant le CLI
      </a>
    </h1>

    <span class="post-date">Wed, Jan 28, 2015</span>

    

<p>Vous pouvez gérer les routes SMTP sortantes directement en ligne de commande, ce document vous donne les références concernant les fonctionnalités implémentées.</p>

<p>Avant d&rsquo;aller plus loin je vous recommande la lecture de la <a href="doc/routes-smtp-sortantes/">documentation expliquant le fonctionnement des routes SMTP</a> principalement pour savoir l&rsquo;ordre dans lequel les règles sont testées. Il faut savoir que la première route qui correspond sera celle qui sera utilisée, donc si vous ne voulez pas avoir de surprise il est capital de bien assimiler ce point.</p>

<h3 id="lister-toutes-les-routes:253091a785f27e2f20aac978da09c51f">Lister toutes les routes</h3>

<p>La commande pour lister les routes est:</p>

<pre><code>tmail routes list

1 - Destination host: toorop.fr - Prority: 1 - Local IPs: default - Remote host: mail.toorop.fr:25
2 - Destination host: tmail.io - Prority: 1 - Local IPs: default - Remote host: mail.tmail.io:25
</code></pre>

<p>Pour le moment il n&rsquo;y a pas de paramètres pour spécifier des critères de recherche. Si vous avez besoin de rechercher une route particulière, le plus simple pour le moment est d&rsquo;utiliser l&rsquo;outil <em>grep</em> pour filtrer la sortie de la commande <em>tmail routes list</em>.<br />
Par exemple si vous voulez chercher les routes faisant référence au domaine tmail.io :</p>

<pre><code>tmail routes list | grep tmail.io
</code></pre>

<h3 id="ajouter-une-régle-de-routage-smtp:253091a785f27e2f20aac978da09c51f">Ajouter une régle de routage SMTP</h3>

<h4 id="aide-en-ligne:253091a785f27e2f20aac978da09c51f">Aide en ligne</h4>

<pre><code>tmail routes add --help
NAME:
    add - Add a route
USAGE:
    command add [command options] [arguments...]
DESCRIPTION:
    tmail routes add -d DESTINATION_HOST -rh REMOTE_HOST [-rp REMOTE_PORT] [-p PRORITY] [-l LOCAL_IP] [-u AUTHENTIFIED_USER] [-f MAIL_FROM] [-rl REMOTE_LOGIN] [-rpwd REMOTE_PASSWD]

OPTIONS:
    --destination, -d       hostame destination, eg domain in rcpt user@domain
    --remote host, --rh         remote host, eg where email should be deliver
    --remotePort, --rp &quot;25&quot; Route port
    --priority, -p &quot;1&quot;      Route priority. Lowest-numbered priority routes are the most preferred
    --localIp, -l       Local IP(s) to use. If you want to add multiple IP separate them by | for round-robin or &amp; for failover. Don't mix &amp; and |
    --smtpUser, -u      Routes for authentified user user.
    --mailFrom, -f      Routes for MAIL FROM. User need to be authentified
    --remoteLogin, --rl         SMTPauth login for remote host
    --remotePasswd, --rpwd  SMTPauth passwd for remote host
</code></pre>

<h4 id="exemples:253091a785f27e2f20aac978da09c51f">Exemples</h4>

<p>Ajouter une route pour relayer les mails à destination du domaine tmail.io vers mail.tmail.io</p>

<pre><code>tmail routes add -d tmail.io -rh mail.tmail.io
</code></pre>

<p>Vous pouvez spécifier un port distant</p>

<pre><code>tmail routes add -d tmail.io -rh mail.tmail.io -rp 2525 
</code></pre>

<p>Si le serveur distant nécessite une authentification SMTP ajouter les options rl et rpwd</p>

<pre><code>tmail route add -d tmail.io -rh mail.tmail.io -rp 587 -rl login -rpwd passwd
</code></pre>

<p>Vous pouvez créer des routes qui vont agir en fonction de l&rsquo;utilisateur qui à soumis le mail ( à la condition bien entendu qu&rsquo;il se soit authentifié via SMTPAUTH). Imaginons par exemple que vous souhaitiez router les mails soumis par l&rsquo;utilisateur toorop@tmail.io vers le relais premium.tmail.io</p>

<pre><code>tmail route add -rh premium.tmail.io -u toorop@tmail.io
</code></pre>

<p>Si vous voulez attribuer une route spécifique à tous les utilisateurs d&rsquo;un domaine, la solution consiste  à utiliser leur adresse email comme login SMTP et ensuite de créer une règle en mettant le domaine comme valeur pour l&rsquo;option u. Par exemple si vous souhaitez que les mails de tous les utilisateurs identifiés comme faisant partie du domaine domaine tmail.io aient leurs mails routés par Mailjet :</p>

<pre><code>tmail route add -rh in.mailjet.com -u tmail.io -rl mailjet_login -rpwd mailjet_passwd
</code></pre>

<p>Si vous voulez ajouter comme contrainte que l’expéditeur du mail (MAIL FROM) doit etre en @tmail.io :</p>

<pre><code> tmail route add -rh in.mailjet.com -u tmail.io -f tmail.io -rl mailjet_login -rpwd mailjet_passwd
</code></pre>

<h4 id="round-robin:253091a785f27e2f20aac978da09c51f">Round Robin</h4>

<p>Vous pouvez mettre deux (ou plus) routes identiques. Bien entendu ça n&rsquo;a aucun intérêt si ce sont les seules routes pour une destination donnée, mais dans le cas contraire cela permet de repartir les mails vers plusieurs relais en leur attribuant un poids. Par exemple imaginons que nous souhaitions faire passer deux fois plus de mails par big.smtp.tmail.io que par small.smtp.tmail.io :</p>

<pre><code>tmail route add -d tmail.io -rh big.smtp.tmail.io
tmail route add -d tmail.io -rh big.smtp.tmail.io
tmail route add -d tmail.io -rh small.smtp.tmail.io
</code></pre>

<h4 id="failover:253091a785f27e2f20aac978da09c51f">Failover</h4>

<p>En ajoutant un paramètre de priorité, vous pouvez créer des routes secondaires qui vont qui vont etres utilisé sur les routes de priorité plus élevées sont en échecs.</p>

<p>Par exemple:</p>

<pre><code>tmail route add -d tmail.io -rh main.smtp.tmail.io -p 1
tmail route add -d tmail.io -rh alt1.smtp.tmail.io -p 2
tmail route add -d tmail.io -rh alt2.smtp.tmail.io -p 3
</code></pre>

<p>Dans ce cas tmail va d&rsquo;abord tenter de transmettre le mail à main.smtp.tmail.io puis ça ça échoue à alt1.smtp.tmail.io et si ça échoue toujours à alt2.smtp.tmail.io</p>

<p>Notez que vous pouvez mixer failover et roundrobin, par exemple:</p>

<pre><code>tmail route add -d tmail.io -rh main.smtp.tmail.io -p 1
tmail route add -d tmail.io -rh alt1.smtp.tmail.io -p 2
tmail route add -d tmail.io -rh alt2.smtp.tmail.io -p 2
</code></pre>

<p>Dans ce cas si tmail n&rsquo;arrive pas a transmettre le mail à main.smtp.tmail.io il va faire le second essais vers alt1 ou alt2.</p>

<h3 id="supprimer-une-règle-de-routage-smtp:253091a785f27e2f20aac978da09c51f">Supprimer une règle de routage SMTP</h3>

<pre><code>tmail routes del ROUTE_ID
</code></pre>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://tmail.io/doc/cli-gestion-queue/">
        Gestion de la queue en utilisant le CLI
      </a>
    </h1>

    <span class="post-date">Wed, Jan 21, 2015</span>

    

<h4 id="lister-les-messages-en-queue:a5ae8842e5f4cb42bab09bbc9c21cead">Lister les messages en queue</h4>

<p>La commande pour lister les messages en queue est:</p>

<pre><code>tmail queue list
</code></pre>

<p>Pour chaque mail en queue les informations suivantes sont retournées:</p>

<ul>
<li>Identifiant du mail en queue</li>
<li>From: expéditeur du mail</li>
<li>To:  destinataire du mail</li>
<li>Status: status du mail. Actuellement les status sont &ldquo;Delivery in progress&rdquo;, &ldquo;Scheduled&rdquo;, &ldquo;Will be discarded&rdquo;, &ldquo;Will be bounced&rdquo;</li>
<li>Next delivery process scheduled at: Dans le cas ou un mail est en attente dans la queue ce paramètre indique le moment (approximatif) où le mail sera représenté au process tmail qui traite les message en queue.</li>
</ul>

<p>Cas où il n&rsquo;y a pas de message en queue:</p>

<pre><code>tmail queue list

There is no message in queue.
</code></pre>

<p>Cas où il y a un message en queue qui est en train d&rsquo;être délivré:</p>

<pre><code>tmail queue list

1 messages in queue.

12564 - From: toorop@toorop.fr - To: toorop@toorop.fr - Status: Delivery in progress - Added: 2015-01-23 09:10:40.271449372 +0100 CET 
</code></pre>

<p>Cas où il y un message en queue en attente:</p>

<pre><code>1 messages in queue.
12564 - From: toorop@toorop.fr - To: toorop@toorop.fr - Status: Scheduled - Added: 2015-01-23 09:10:40.271449372 +0100 CET - Next delivery process scheduled at: 2015-01-23 09:14:40.464895229 +0100 CET
</code></pre>

<h4 id="supprimer-un-message-discard:a5ae8842e5f4cb42bab09bbc9c21cead">Supprimer un message (discard)</h4>

<p>La commande suivante va vous permettre de supprimer un message de la queue:</p>

<pre><code>tmail discard MESSAGE_ID
</code></pre>

<p>Attention le mail ne sera pas supprimé instantanément, il le sera lorsqu&rsquo;il sera présenté à tmail pour être traité.</p>

<p>Dans la mesure du possible il est préférable de bouncer un mail plutôt que de le supprimer pour que l&rsquo;expéditeur soit informé du fait que son mail n&rsquo;a pas abouti.</p>

<h4 id="bouncer-un-message:a5ae8842e5f4cb42bab09bbc9c21cead">Bouncer un message</h4>

<p>Bouncer un message consiste à le supprimer de la queue et à envoyer un message à l&rsquo;expéditeur pour l&rsquo;informer que son mail n&rsquo;est pas arrivé à destination.</p>

<p>La commande pour bouncer un mail est:</p>

<pre><code>    tmail bounce MESSAGE_ID
</code></pre>

<p>Comme pour la commande discard, le bounce n&rsquo;est pas instantané il se fera lorsque le mail sera représenté à tmail pour être délivré.</p>

<h4 id="relancer-la-queue-flush:a5ae8842e5f4cb42bab09bbc9c21cead">Relancer la queue (flush)</h4>

<p>Pour le moment cette commande n&rsquo;est pas implémentée. En attendant, pour relancer la queue il vous suffit de relancer tmail.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://tmail.io/doc/routes-smtp-sortantes/">
        Routes smtp sortantes
      </a>
    </h1>

    <span class="post-date">Mon, Jan 19, 2015</span>

    

<p><strong>tmail vous permet de spécifier des routes sortantes pour les mails qu&rsquo;il a à expédier.</strong></p>

<p>Par défaut, lorsque tmail doit transmettre un mail il va faire une requête DNS MX pour obtenir les adresses IP du/des serveur(s) SMTP du domaine de destination. C&rsquo;est le fonctionnement classique d&rsquo;un serveur SMTP, mais vous pouvez aussi créer des règles de routage pour forcer les connexions sortantes vers des relais spécifiques.</p>

<p>Les règles de routage vont êtres définies an fonction des paramètres suivants :</p>

<ul>
<li>Le domaine de destination.</li>
<li>L&rsquo;expéditeur à la condition que le mail ait été originalement transmis à tmail par un utilisateur authentifié (via SMTP AUTH).</li>
</ul>

<p>Lorsque tmail à un mail à transmettre il va chercher parmi les règles suivantes si il y en a une qui correspond.</p>

<ul>
<li><p><strong>Si il trouve une règle</strong>, il va utiliser les routes qui correspondent à cette règle. Chaque route à un poids, comme pour les MX classiques, tmail va donc essayer en premier lieu de se connecter au relais suivant en utilisant la route qui a le poids le plus faible. Dans le cas où plusieurs routes ont le même poids, il va les ordonner aléatoirement ce qui va permettre de faire facilement du round-robin.</p></li>

<li><p><strong>Si il n&rsquo;en trouve pas</strong>, il va utiliser les MX du domaine de destination.</p></li>
</ul>

<p>Les règles sont testées dans l&rsquo;ordre suivant:</p>

<ul>
<li><p><strong>Si le mail à été transmis via SMTPAUTH:</strong> tmail va chercher une règle liée à l&rsquo;utilisateur authentifié qui correspond à l&rsquo;expéditeur (MAIL FROM de l’enveloppe SMTP) et au domaine de destination.</p></li>

<li><p><strong>Si le mail à été transmis via SMTPAUTH:</strong> tmail va chercher une règle liée à l&rsquo;utilisateur authentifié qui correspond au domaine de l&rsquo;expéditeur (MAIL FROM de l’enveloppe SMTP) et au domaine de destination.</p></li>

<li><p><strong>Si le mail à été transmis via SMTPAUTH:</strong> tmail va chercher une règle liée à l&rsquo;utilisateur authentifié qui correspond au domaine de destination.</p></li>

<li><p><strong>Si le mail à été transmis via SMTPAUTH:</strong> tmail va chercher une règle &lsquo;générique&rsquo; liée à l&rsquo;utilisateur authentifié.</p></li>

<li><p>tmail va chercher une règle qui correspond au domaine de destination.</p></li>

<li><p>tmail va chercher une règle par défaut (wildcard &ldquo;*&rdquo; sur le domaine de destination)</p></li>
</ul>

<p>Par <em>règle liée à l&rsquo;utilisateur authentifié</em> j&rsquo;entends une règle lié au login complet de cet utilisateur, ou si il n&rsquo;y en a pas et que ce login est de la forme user@domaine.tld un règle lié à domaine.tld</p>

<h4 id="a-venir-création-des-règles-de-routage:5e9d67da96eda8e125d0b466af0f081e">A venir: Création des règles de routage</h4>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://tmail.io/faq/">
        FAQ
      </a>
    </h1>

    <span class="post-date">Wed, Jan 14, 2015</span>

    

<ul>
<li><a href="#tmail:4a1318da06786ac52626178ca960109e">Qu&rsquo;est ce que tmail ? </a></li>
<li><a href="#opensource:4a1318da06786ac52626178ca960109e">Est ce que tmail est opensource ? </a></li>
<li><a href="#tester-tmail:4a1318da06786ac52626178ca960109e">Peut on tester tmail ? </a></li>
<li><a href="#golang-tmail:4a1318da06786ac52626178ca960109e">tmail est codé en quel langage ? </a></li>
</ul>

<h2 id="tmail:4a1318da06786ac52626178ca960109e">Qu&rsquo;est ce que tmail ?</h2>

<p>Réponse courte: tmail est un serveur <a href="http://fr.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol">SMTP</a></p>

<p><strong>Mais pourquoi créer un nouveau serveur smtp !?</strong></p>

<p>Oui c&rsquo;est vrai ça pourquoi créer un nouveau serveur SMTP alors qu&rsquo;il existe déjà qmail, postfix, exim, sendmail, .. ?<br />
Parce que :</p>

<ul>
<li><p>Ces serveurs ont été conçu à une époque où les problématiques et donc les besoins liés à l’émail étaient différents. Je pense en particulier à la problématique du spam, aujourd&rsquo;hui il est indispensable de filtrer ce qui entre et ce qui sort d&rsquo;un serveur SMTP, d&rsquo;établir de règles strictes quant à l&rsquo;usage du service: par exemple l&rsquo;user X ne peux envoyer plus de x mails par jour, chaque mail ne doit pas faire plus de x Mo et il ne peut utiliser le service le week-end ou encore de pas envoyer plus de x mails par minute vers telle destination&hellip;</p></li>

<li><p>Avoir un système fiable et parfaitement redondant nécessite pas mal de compromis.</p></li>

<li><p>La scalabilité apportée par les solutions actuelles n&rsquo;est pas simple à mettre en place et est difficilement linéaire.</p></li>

<li><p>Plus globalement, la mise en place et l&rsquo;administration de ces serveurs n&rsquo;est pas forcement simple non plus. Attention le but n&rsquo;est pas de permettre à n&rsquo;importe qui ne mettre en place un service SMTP, mais plutôt de libérer les sysadmins de contraintes inutiles.</p></li>

<li><p>Enfin ça fait des années que je travaille dans ce secteur (pour <a href="http://protecmail.com/" target="_blank" title="Protection de messagerie">Protecmail</a>) et ça fait presque aussi longtemps que je me dis:<br />
<em>Un jour je coderais mon propre serveur</em> ;)</p></li>
</ul>

<h2 id="opensource:4a1318da06786ac52626178ca960109e">Est ce que tmail est opensource ?</h2>

<p>Pour le moment je ne souhaite pas &ldquo;libérer&rdquo; les sources, mais à terme ce sera le cas.</p>

<p>La raison principale est que le projet est trop jeune, je préfère attendre que les grandes lignes soient posées, que ce que j&rsquo;ai prévu soit implémenté - au moins en partie - pour éviter d&rsquo;une part trop de dispersions et d&rsquo;autre part pour pouvoir concentrer mon temps disponible au code plutôt qu&rsquo;à la gestion du projet.</p>

<h2 id="tester-tmail:4a1318da06786ac52626178ca960109e">Peut on tester tmail ?</h2>

<p>Même si il n&rsquo;est pas - encore - open source, je vais mettre à disposition des binaires et la documentation pour permettre à ceux qui le désire de tester tmail.<br />
Bien entendu les versions proposées en test, seront des versions de dev qui implémenteront que.. ce qui est implémenté et qui ne seront pas exemptes de bugs.</p>

<h2 id="golang-tmail:4a1318da06786ac52626178ca960109e">tmail est codé en quel langage ?</h2>

<p><a href="http://golang.org/" target="_blank" title="golang">Go</a></p>

  </div>
  
</div>
</div>

  </body>
</html>
