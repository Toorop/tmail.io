<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Docs on tmail</title>
    <link>http://tmail.io/doc/</link>
    <description>Recent content in Docs on tmail</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>fr-fr</language>
    <lastBuildDate>Thu, 28 May 2015 10:24:01 +0200</lastBuildDate>
    <atom:link href="http://tmail.io/doc/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Micro-services</title>
      <link>http://tmail.io/doc/microservices/</link>
      <pubDate>Thu, 28 May 2015 10:24:01 +0200</pubDate>
      
      <guid>http://tmail.io/doc/microservices/</guid>
      <description>

&lt;p&gt;Comme il ne peux y avoir autant d&amp;rsquo;usages possibles que de fonctionnalités implémentées, il m&amp;rsquo;a semblé important de pourvoir ajouter simplement des fonctionnalités à tmail.&lt;/p&gt;

&lt;p&gt;Après avoir longuement réfléchis à la façon d&amp;rsquo;implémenter la chose, il m&amp;rsquo;a semblé que l&amp;rsquo;usage de micro-services était la meilleure solution.&lt;/p&gt;

&lt;p&gt;Pourquoi ?&lt;/p&gt;

&lt;p&gt;Voyons les contraintes:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Fiable: est il vraiment nécessaire de préciser ce point ? ;)&lt;/li&gt;
&lt;li&gt;Facile: n&amp;rsquo;importe qui, à condition d&amp;rsquo;avoir quelques base en programmation, doit être en mesure d&amp;rsquo;écrire une extension pour tmail.&lt;/li&gt;
&lt;li&gt;Multi langage: on ne doit pas être limité à un langage de programmation.&lt;/li&gt;
&lt;li&gt;Scalable: on doit pouvoir adapter simplement et rapidement les ressources aux besoins.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Comment y répondre:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;De part leur indépendance vis à vis du logiciel client, ici tmail, les micro-services ne viendront impacter ce dernier en cas de problème. En clair si un micro-service plante, il n&amp;rsquo;y aura pas d&amp;rsquo;impact sur pas la fiabilité et le disponibilité du service.&lt;/li&gt;
&lt;li&gt;HTTP est un protocole répandu, fiable et maîtrisé par de nombreux dev, il est donc tout à fait adapté comme protocole de communication entre le client (tmail) et les micro-services.&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://developers.google.com/protocol-buffers/&#34; target=&#34;_blank&#34; title=&#34;Protocol Buffers&#34;&gt; Protocol Buffers &lt;/a&gt; est un format de sérialisation très performant, il permet un contrôle sur la structure et le type des donnés échangées, des implémentations existent dans les langages les plus courant,.. bref il semble le parfait candidat pour ce qui concerne le format d&amp;rsquo;échange de données..&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;sommaire:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Sommaire&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#principes:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Principes de base &lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#configuration:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Configuration &lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#parametres:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Paramètres&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#reponses:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Réponses &lt;/a&gt;&lt;br /&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#smtpdreponse:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;SmtpdResponse &lt;/a&gt;&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#hooks:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Points d&amp;rsquo;entré &lt;/a&gt;&lt;br /&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#smtpdnewclient:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Initialisation de la connexion&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#smtpddata:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Après la commande DATA&lt;/a&gt;&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#exempleimpl:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Exemples d&amp;rsquo;implémentation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#msas:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Micro-Services As Service&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#greysmtpd:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Grey SMTP&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#dkimverif:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Vérification DKIL&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;principes:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Principes de base&lt;/h2&gt;

&lt;p&gt;A différentes étapes du traitement, tmail va vérifier si des micro-services sont configurées et le cas échéant il va les interroger.&lt;/p&gt;

&lt;p&gt;Prenons un exemple concret, si un micro-service est configuré pour être interrogé lors de l’établissement d&amp;rsquo;une connexion avec un nouveau client SMTP, tmail va sérialiser l&amp;rsquo;identifiant de la sessions SMTP et l&amp;rsquo;adresse IP du client distant et va les transmettre via une requête HTTP POST vers le micro service.&lt;/p&gt;

&lt;p&gt;Il va attendre (ou pas), là réponse et en fonction de cette dernière, va soit continuer le traitement, soit l&amp;rsquo;interrompre en transmettant un message au client.&lt;/p&gt;

&lt;p&gt;La tache du micro-service pourrait être, par exemple, de vérifier si l&amp;rsquo;IP est blacklistée sur une RBL, et si c&amp;rsquo;est le cas alors le micro-service &amp;ldquo;demanderait&amp;rdquo; à tmail de refuser la connexion. (ce qui en passant n&amp;rsquo;est pas une bonne idée, mais bon, c&amp;rsquo;est pour l&amp;rsquo;exemple ;) )&lt;/p&gt;

&lt;h2 id=&#34;configuration:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Configuration&lt;/h2&gt;

&lt;p&gt;Pour chaque étape où des micro-services sont appelables, vous allez trouver dans le fichier de configuration une variable de ce type :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Microservices
# On new incomming SMTP connection
TMAIL_MS_SMTPD_NEWCLIENT=&amp;quot;&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Un micro-service est défini par une URL:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;https://ms.tmail.io/smtpdnewclient?param1=x&amp;amp;param2=y
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Avec:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://ms.tmail.io/smtpdnewclient:&#34;&gt;https://ms.tmail.io/smtpdnewclient:&lt;/a&gt; l&amp;rsquo;URL vers laquelle sera posté les données sérialisées&lt;/li&gt;
&lt;li&gt;&amp;ldquo;param1=x&amp;amp;param2=y&amp;rdquo; les paramètres de configuration de ce micro-service (voir la liste plus bas). Attention ces paramètres ne seront pas transmis au micro-services.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Il est possible, d&amp;rsquo;appeler plusieurs micro-services en séparant les URL d&amp;rsquo;un point virgule.&lt;/p&gt;

&lt;p&gt;Par exemple :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;TMAIL_MS_SMTPD_NEWCLIENT=&amp;quot;https://ms.tmail.io/check-spamcop?timeout=15; https://ms.tmail.io/stats?fireandforget=true&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Dans ce cas tmail va appeler &lt;a href=&#34;https://ms.tmail.io/check-spamcop&#34;&gt;https://ms.tmail.io/check-spamcop&lt;/a&gt; et ensuite &lt;a href=&#34;https://ms.tmail.io/stats&#34;&gt;https://ms.tmail.io/stats&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;parametres:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Paramètres&lt;/h3&gt;

&lt;p&gt;Les paramètres d&amp;rsquo;URL actuellement reconnu par tmail sont:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;timeout&lt;/strong&gt; (default: 30): permet d&amp;rsquo;indiquer un timeout (en seconde) sur un appel. Par défaut il est de 30 secondes.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;onfailure&lt;/strong&gt; (default: continue): permet de spécifier une action si un appel échoue. Globalement un appel échoue si le timeout est déclenché ou si le code de retour HTTP indique une erreur (4xx ou 5xx).
Les valeurs possibles pour ce paramètre sont:

&lt;ul&gt;
&lt;li&gt;continue: le traitement continue normalement.&lt;/li&gt;
&lt;li&gt;tempfail: si une erreur à lieu pendant une transaction SMTP entrante, une temporaire (4xx) est retournée au client SMTP (xx), si c&amp;rsquo;est pendant la livraison d&amp;rsquo;un mail ou lors d&amp;rsquo;une transaction sortante le mail est remis en queue.&lt;/li&gt;
&lt;li&gt;permfail: si une erreur à lieu pendant une transaction SMTP entrante, une erreur permanente (5xx) est retournée au client SMTP, si c&amp;rsquo;est pendant la livraison d&amp;rsquo;un mail ou lors d&amp;rsquo;une transaction sortante le mail est remis en queue.&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;fireandforget&lt;/strong&gt; (default false): si ce paramètre est défini à true, tmail va exécuter la requête dans un process parallèle et ne va pas tenir compte de la réponse. Autrement dit ce genre de traitement n&amp;rsquo;a aucune incidence sur le traitement réalisé par tmail. Attention cette option n&amp;rsquo;est pas disponible pour tous les hooks.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;reponses:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Réponses&lt;/h2&gt;

&lt;p&gt;Les réponses retournée par le micro-service sont des structures sérialisés avec protobuf, elles sont définies par leur fichier .proto&lt;/p&gt;

&lt;p&gt;Vous trouverez le fichier proto &lt;a href=&#34;hhttps://github.com/toorop/tmail-ms-server/tree/master/proto&#34; target=&#34;_blank&#34; title=&#34;tmail proto&#34;&gt; &lt;a href=&#34;https://github.com/toorop/tmail-ms-server/tree/master/proto&#34;&gt;https://github.com/toorop/tmail-ms-server/tree/master/proto&lt;/a&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;smtpdreponse:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;SmtpdResponse&lt;/h3&gt;

&lt;p&gt;C&amp;rsquo;est cette structure que votre microservice doit retourner si il est appelé durant une transaction SMTP entrante.&lt;/p&gt;

&lt;p&gt;Sa définition est la suivante :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;message SmtpdResponse {
    required int32 smtp_code = 1;   // SMTP code
    required string smtp_msg = 2;   // SMTP message

    optional bool close_connection = 16;// if true connection wil be closed
    optional string data_link = 17;     // link for downloading additional (large) data 
    repeated string extra_headers = 18; // headers to add 
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Avec:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;smtp_code&lt;/strong&gt; (requis): le code SMTP qui, si il est différent de 0, va être retourné au client.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;smtp_msg&lt;/strong&gt; (requis): le message qui, si il est différent de &amp;ldquo;&amp;rdquo; (chaîne vide), va être associé au code SMTP pour créer la réponse à retourner au client.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;close_connection&lt;/strong&gt; (optionnel, défaut: false): si ce paramètre est à défini sur &lt;em&gt;true&lt;/em&gt; alors tmail, va mettre fin à la transaction après avoir retourné au client les message &amp;ldquo;smtp_code smtp_msg&amp;rdquo; si il est défini, ou un message d&amp;rsquo;erreur temporaire dans le cas contraire.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;data_link&lt;/strong&gt; (optionnel): lien pointant vers des données trop volumineuses pour êtres contenues dans la réponse.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;extra_headers&lt;/strong&gt; (optionnel): d&amp;rsquo;éventuels headers à ajouter.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Je suppose que certain d&amp;rsquo;entre vous se demandent: pourquoi est il passé de 2 à 16 ? Parce que protobuf ne va pas encoder les noms des variables mais va utiliser le &lt;em&gt;flag&lt;/em&gt; qui lui est associé. Si ce flag est inférieur à 16, une fois encodé le flag et le type de la variable vont occuper un byte, à partir de 16, il va falloir utiliser 2 bytes. Autrement dit, il est judicieux de conserver les tags 1 à 15 pour les éléments requis et 16 et plus pour ceux qui sont optionnels histoire de gagner quelque bytes.&lt;/p&gt;

&lt;h2 id=&#34;hooks:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Étapes &amp;ldquo;hookables&amp;rdquo;&lt;/h2&gt;

&lt;p&gt;Voici la liste des points (hook) où il est possible d&amp;rsquo;étendre tmail par l&amp;rsquo;usage de micro-services.&lt;/p&gt;

&lt;h3 id=&#34;smtpdnewclient:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;SmtpdNewClient: Établissement d&amp;rsquo;une nouvelle connexion SMTP entrante&lt;/h3&gt;

&lt;p&gt;Le point d&amp;rsquo;entré dans la configuration est :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;TMAIL_MS_SMTPD_NEWCLIENT=&amp;quot;&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;La structure transmise au micro-service est la suivante:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;message SmtpdNewClientMsg {
    required string session_id = 1; // smtpd session ID
    required string remote_ip = 2;  // remote (client) IP
}   
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Avec:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;session_id&lt;/strong&gt; (requis): l&amp;rsquo;identifiant de la session SMTP qui traite cette transaction. Cet identifiant va être transmis dans tous les appels qui auront lieu durant une même transaction SMTP, il va donc permettre de suivre cette transaction, coté micro-service, et de lier les requêtes.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;remote_ip&lt;/strong&gt; (requis): contient l&amp;rsquo;IP du client.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;La réponse attendue par tmail doit être un message du type &lt;em&gt;SmtpdResponse&lt;/em&gt;.&lt;/p&gt;

&lt;h2 id=&#34;exemples-d-implémentation:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Exemples d&amp;rsquo;implémentation :&lt;/h2&gt;

&lt;p&gt;Vous trouverez sur &lt;a href=&#34;https://github.com/toorop/tmail-ms-server&#34;&gt;https://github.com/toorop/tmail-ms-server&lt;/a&gt; différent exemples de micro-services pour tmail.
N&amp;rsquo;hésitez pas à participer à ce repo en proposant vos propres exemples. Si vous souhaitez publier un exemple dans un langage qui n&amp;rsquo;a pas encore de dossier spécifique, créez le à la racine du repo.&lt;/p&gt;

&lt;h3 id=&#34;smtpddata:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;SmtpdData: Après la commande SMTP DATA&lt;/h3&gt;

&lt;p&gt;Le point d&amp;rsquo;entré dans la configuration est :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;export TMAIL_MS_SMTPD_DATA=&amp;quot;&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;La structure transmise au micro-service est la suivante:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;message SmtpdDataMsg {
    required string session_id = 1;
    required string data_link = 2;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Avec:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;session_id&lt;/strong&gt; (requis): l&amp;rsquo;identifiant de la session SMTP qui traite cette transaction. Cet identifiant va être transmis dans tous les appels qui auront lieu durant une même transaction SMTP, il va donc permettre de suivre cette transaction, coté micro-service, et de lier les requêtes.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;data_link&lt;/strong&gt; (requis): Un lien HTTP depuis lequel le micro-service pourra télécharger le mail transmis par le commande DATA.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;La réponse attendue par tmail doit être un message du type &lt;em&gt;SmtpdResponse&lt;/em&gt;.&lt;/p&gt;

&lt;h2 id=&#34;exempleimpl:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;Exemples d&amp;rsquo;implémentation&lt;/h2&gt;

&lt;p&gt;Vous trouverez sur &lt;a href=&#34;https://github.com/toorop/tmail-ms-server&#34;&gt;https://github.com/toorop/tmail-ms-server&lt;/a&gt; différent exemples de micro-services pour tmail.
N&amp;rsquo;hésitez pas à participer à ce repo en proposant vos propres exemples. Si vous souhaitez publier un exemple dans un langage qui n&amp;rsquo;a pas encore de dossier spécifique, créez le à la racine du repo.&lt;/p&gt;

&lt;h2 id=&#34;msas:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;μsas: Micro-Services As Services&lt;/h2&gt;

&lt;p&gt;Un des autres intérêts de cette architecture est qu&amp;rsquo;il est possible de proposer des &lt;strong&gt;micro-services as service&lt;/strong&gt;, autrement dit de mettre à dispositions des utilisateurs de tmail des micro-services que l&amp;rsquo;on a codé et que l&amp;rsquo;on héberge.&lt;/p&gt;

&lt;p&gt;C&amp;rsquo;est ce que je vous propose ici, l&amp;rsquo;usage en est totalement libre et gratuit.&lt;/p&gt;

&lt;p&gt;Le code de ses micro-services est disponible ici: &lt;a href=&#34;https://github.com/toorop/tmail-ms-server/tree/master/golang/ms.tmail.io&#34;&gt;https://github.com/toorop/tmail-ms-server/tree/master/golang/ms.tmail.io&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;greysmtpd:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;SMTPD_NEWCLIENT: GreySmtpd&lt;/h3&gt;

&lt;p&gt;&lt;strong&gt;URL:&lt;/strong&gt; &lt;a href=&#34;https://ms.tmail.io/smtpdnewclientgreysmtpd&#34;&gt;https://ms.tmail.io/smtpdnewclientgreysmtpd&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Ce service va accepter ou refuser temporairement la connexion en fonction de la réputation de l&amp;rsquo;IP du client.&lt;/p&gt;

&lt;p&gt;Un client SMTP légitime va tenter à plusieurs reprises de transmettre un mail en cas d&amp;rsquo;échec des tentatives précédentes (si le serveur à retourné une erreur temporaire), l&amp;rsquo;idée ici est donc d&amp;rsquo;exploiter cette fonctionnalité pour écarter un maximum de spambot.&lt;/p&gt;

&lt;p&gt;Actuellement l&amp;rsquo;implémentation est la suivante:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Si une IP est suspecte (pas de reverse || listée sur spamcop):

&lt;ul&gt;
&lt;li&gt;Si elle n&amp;rsquo;est pas connue du micro-service, ou si elle est connue depuis moins de 2 heures, une erreur temporaire est retournée.&lt;/li&gt;
&lt;li&gt;Si elle est connue depuis plus de 3 heures et moins de 24 heures, on continue.&lt;/li&gt;
&lt;li&gt;Si elle connue depuis plus de 24 heures, l&amp;rsquo;horodatage est réinitialisé, le micro-service l&amp;rsquo;oubli, et une erreur temporaire est retournée.&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;dkimverif:24c62ab0ae8d6139f10d3d52cfeca2af&#34;&gt;SMTPD_DATA: DKIM verification&lt;/h3&gt;

&lt;p&gt;&lt;strong&gt;URL:&lt;/strong&gt; &lt;a href=&#34;https://ms.tmail.io/smtpddatadkimverif&#34;&gt;https://ms.tmail.io/smtpddatadkimverif&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Ce micro-service va vérifier la signature DKIM du mail, si le mail en a une, et va ajouter un header Authentication-Results.&lt;/p&gt;

&lt;p&gt;Par exemple en cas de succès:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Authentication-Results: dkim=success
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;En cas d&amp;rsquo;échec:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Authentication-Results: dkim=permfail testing body hash did not verify
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>tmail &#43; Docker = un SMTP déployé en moins de 5 minutes </title>
      <link>http://tmail.io/doc/docker-smtp-server/</link>
      <pubDate>Tue, 26 May 2015 18:23:15 +0200</pubDate>
      
      <guid>http://tmail.io/doc/docker-smtp-server/</guid>
      <description>&lt;p&gt;Ça vous dirait de tester tmail mais vous vous dites que vous n&amp;rsquo;avez pas le temps et/ou pas de serveur de disponible ?&lt;/p&gt;

&lt;p&gt;Vous aimeriez avoir votre relais SMTP mais vous vous dites que c&amp;rsquo;est trop compliqué à mettre en place ?&lt;/p&gt;

&lt;p&gt;Pfff balayez moi toute ces excuses bidons, dans ce tuto je vais vous montrer comment déployer tmail en tant que relais SMTP en quelques minutes et pour quelques centimes d&amp;rsquo;euro (voir rien du tout si vous êtes client OVH).&lt;/p&gt;

&lt;p&gt;&lt;img class=&#34;center&#34; src=&#34;http://tmail.io/img/amazing.png&#34;&gt;&lt;/p&gt;

&lt;p&gt;&lt;br&gt;
Avant toute chose, tmail est en plein développement, donc considérez ce tuto comme un &lt;a href=&#34;http://fr.wikipedia.org/wiki/Preuve_de_concept&#34; target=&#34;_blank&#34; title=&#34;preuve de concept&#34;&gt; poc &lt;/a&gt; et n&amp;rsquo;utilisez pas le SMTP pour des choses importantes, il y à forcement des bugs qui traînent.&lt;/p&gt;

&lt;p&gt;Bien commençons par le commencement, il va nous falloir un serveur, nos amis de chez OVH ont eu la bonne idée de sortir &lt;a href=&#34;http://www.ovh.com/fr/cloud/&#34; target=&#34;_blank&#34; title=&#34;cloud OVH&#34;&gt; leur offre cloud &lt;/a&gt; cette semaine, ne cherchons pas plus loin.&lt;/p&gt;

&lt;p&gt;A moins que vous ayez des millions de mails à envoyer par jour leur offre KS1 sera largement suffisante et à 0.008 € de l&amp;rsquo;heure elle ne devrait pas vous ruiner. On va donc lancer une instance de ce type avec Ubuntu 14.04 comme distribution.&lt;/p&gt;

&lt;p&gt;Comptez jusqu’à 30:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;30 29 28 27 26 25 24 23 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Ça y est ?&lt;br /&gt;
L&amp;rsquo;instance est donc prête, on s&amp;rsquo;y connecte:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;ssh admin@IP
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;On passe en root et on met le système à jour:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo su
apt-get update &amp;amp;&amp;amp; apt-get -y upgrade
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;On installe Docker:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;wget -qO- https://get.docker.com/ | sh
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;On ajoute un utilisateur &lt;em&gt;tmail&lt;/em&gt; qui va avoir le droit d&amp;rsquo;utiliser Docker:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;adduser -q --disabled-password  tmail   
usermod -aG docker tmail
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;On bascule sous l&amp;rsquo;user tmail :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;su tmail 
cd
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Si vous êtes vraiment pressé il ne vous reste plus qu&amp;rsquo;a faire:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;docker build -t tmail https://raw.githubusercontent.com/toorop/dockerfiles/master/tmail/Dokerfile
docker run -d -p 587:2525 tmail
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Et voila, c&amp;rsquo;est fini vous pouvez utiliser le smtp pour envoyer vos mails.&lt;/p&gt;

&lt;p&gt;Voici la configuration à utiliser:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Adresse du serveur: adresse IP publique de votre instance&lt;/li&gt;
&lt;li&gt;Port: 587&lt;/li&gt;
&lt;li&gt;STARTTLS&lt;/li&gt;
&lt;li&gt;SMTPAUTH: mots de passe en clair (pensez bien à activer STARTTLS)&lt;/li&gt;
&lt;li&gt;Utilisateur: tmail&lt;/li&gt;
&lt;li&gt;Mot de passe: tmailpasswd&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Votre client va couiner car le certificat est auto-signé, il vous faudra ajouter une exception de sécurité.&lt;/p&gt;

&lt;p&gt;Tant que j&amp;rsquo;y pense les mails sortant auront une signature DKIM. La &lt;a href=&#34;https://github.com/toorop/go-dkim&#34; target=&#34;_blank&#34; title=&#34;DKIM library for Golang&#34;&gt; lib DKIM &lt;/a&gt; étant toute fraîche je ne garantie rien, mais dans tous les cas ça ne doit pas poser de problème car la signature est signalée comme étant en test (en clair si à la vérification la signature n&amp;rsquo;est pas valide, on ne doit pas en tenir compte) .&lt;/p&gt;

&lt;p&gt;Bien entendu le couple login/passwd étant le même pour tout le monde, et surtout connu de tous, je vous conseille fortement de couper ce container dés que vous avez fini les tests.&lt;/p&gt;

&lt;p&gt;Si vous souhaitez aller plus loin, autrement dit si vous souhaitez garder le service SMTP, il vous faut changer le couple user/passwd.&lt;/p&gt;

&lt;p&gt;Pour cela stopper et supprimer le container:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    docker stop CONTAINER_ID
    docker rm CONTAINER_ID
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Téléchargez le &lt;em&gt;dokerfile&lt;/em&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;wget https://raw.githubusercontent.com/toorop/dockerfiles/master/tmail/Dokerfile
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Éditez le pour modifier &lt;em&gt;tmail&lt;/em&gt; et &lt;em&gt;tmailpasswd&lt;/em&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;RUN . conf/tmail.cfg &amp;amp;&amp;amp; \
./tmail user add -r USER MOT_DE_PASSE
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Et construisez/lancez le container:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;docker build -t tmail .
docker run -d -p 587:2525 tmail
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Un dernier petit tips pour la route, si vous n&amp;rsquo;êtes pas adepte de Docker, pour avoir les logs de tmail:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;docker logs -f ID_CONTAINER
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Attention, le debug est activé, c&amp;rsquo;est très verbeux.&lt;/p&gt;

&lt;p&gt;Finalement il m&amp;rsquo;en reste encore un, pour connaître l&amp;rsquo;identifiant du container:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;core@coreos ~ $ docker ps -a

CONTAINER ID  IMAGE         COMMAND                
b60c7b7cc31f  tmail:latest  &amp;quot;/home/tmail/dist/ru   
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Voila enjoy ;)&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>DKIM</title>
      <link>http://tmail.io/doc/dkim/</link>
      <pubDate>Fri, 15 May 2015 14:33:39 +0200</pubDate>
      
      <guid>http://tmail.io/doc/dkim/</guid>
      <description>

&lt;p&gt;Vous trouverez dans cette section les informations vous permettant d&amp;rsquo;activer et de configurer DKIM.&lt;/p&gt;

&lt;p&gt;Tout d&amp;rsquo;abord un petit rappel sur ce qu&amp;rsquo;est DKIM.&lt;/p&gt;

&lt;p&gt;Pour faire court DKIM permet :&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;De faire le lien entre un mail et une autorité, celle qui l&amp;rsquo;a signé.&lt;/li&gt;
&lt;li&gt;De s&amp;rsquo;assurer de l&amp;rsquo;intégrité d&amp;rsquo;un mail, autrement dit qu&amp;rsquo;il n&amp;rsquo;a pas été modifié entre le moment où il à été signé et le moment où la signature à été vérifiée.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Attention aux légendes urbaines:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Ce n&amp;rsquo;est pas parce qu&amp;rsquo;un mail ayant comme expéditeur contact@mabanque.com à une signature DKIM valide que ce mail  vient de contact@mabanque.com et plus globalement qu&amp;rsquo;il n&amp;rsquo;est pas un spam ou un phishing.&lt;/li&gt;
&lt;li&gt;Ce n&amp;rsquo;est pas parce qu’un mail à une signature DKIM non valide que c&amp;rsquo;est un spam ou un phishing.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;Comme toutes les sections de cette documentation, cette page reflète ce qui est implémenté dans tmail au moment de sa rédaction. Autrement dit pensez à visiter cette page régulièrement car elle sera fréquemment mise à jour&lt;/strong&gt;&lt;/p&gt;

&lt;h2 id=&#34;support-de-dkim:c99c24afa10a30bd9bfec7a5439680ab&#34;&gt;Support de DKIM&lt;/h2&gt;

&lt;p&gt;Le support de DKIM à été introduit dans la version 0.0.8.
Pour le moment il est sommaire, le but est avant tout de tester l&amp;rsquo;implémentation. Autrement dit, actuellement si vous activez DKIM:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Aucune vérification n&amp;rsquo;est faite sur les mails entrant.&lt;/li&gt;
&lt;li&gt;Tous les mails sortant sont signés en utilisant la même clé privée, le domaine &amp;ldquo;tmail.io&amp;rdquo; et le &amp;lsquo;selector&amp;rsquo; &amp;ldquo;test&amp;rdquo;.&lt;/li&gt;
&lt;li&gt;La clé publique, ou plus exactement sa représentation, contient le flag indiquant que c&amp;rsquo;est une signature de test. Autrement dit, l&amp;rsquo;entité qui va vérifier la signature, ne doit pas tenir compte du résultat de cette vérification si elle échoue.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Dans la pratique, vous ne prenez aucun risque à activer DKIM et comme ça va être très utile par valider l&amp;rsquo;implémentation je ne peux que vous encourager à la faire.&lt;/p&gt;

&lt;h2 id=&#34;activer-dkim:c99c24afa10a30bd9bfec7a5439680ab&#34;&gt;Activer DKIM&lt;/h2&gt;

&lt;p&gt;D&amp;rsquo;abord assurez vous d&amp;rsquo;avoir une version de tmail supérieure ou égale à la 0.0.8.&lt;/p&gt;

&lt;p&gt;Ensuite il vous suffit juste de modifier:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# DKIM sign outgoing (remote) emails
export TMAIL_DELIVERD_DKIM_SIGN=false
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;pour:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# DKIM sign outgoing (remote) emails
export TMAIL_DELIVERD_DKIM_SIGN=true
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Et de relancer tmail.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Utilisez l&#39;API REST</title>
      <link>http://tmail.io/doc/api-rest/</link>
      <pubDate>Thu, 02 Apr 2015 11:14:47 +0200</pubDate>
      
      <guid>http://tmail.io/doc/api-rest/</guid>
      <description>

&lt;p&gt;Vous trouverez dans ce document toutes les informations nécessaires pour utiliser l&amp;rsquo;API REST tmail.&lt;/p&gt;

&lt;h2 id=&#34;sommaire:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Sommaire&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#authentification:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Authentification&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#requetes:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Requêtes&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#http_code:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Codes HTTP&lt;/a&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;a href=&#34;#erreurs:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Erreurs&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;a href=&#34;#users:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Gestion des utilisateurs&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#usersAdd:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Ajouter un utilisateur&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#usersDel:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Supprimer un utilisateur&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#usersGetOne:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Retrouver un utilisateur&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#usersGetAll:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Retrouver tous les utilisateurs&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;a href=&#34;#queue:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Gestion de la queue&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#queueListMessages:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Lister les messages en queue&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#queueGetMessage:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Récuperer les information concernant un message&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#queueDiscardMessage:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Supprimer un message&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#queueBounceMessage:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Bouncer un message&lt;/a&gt;&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;authentification:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Authentification&lt;/h3&gt;

&lt;p&gt;L&amp;rsquo;API utilise l&amp;rsquo;authentification &lt;a href=&#34;http://fr.wikipedia.org/wiki/Authentification_HTTP#M.C3.A9thode_.C2.AB_Basic_.C2.BB&#34; target=&#34;_blank&#34;&gt;HTTP Basic&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Pourquoi ce type d’authentification ?&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;simple à mettre en œuvre&lt;/li&gt;
&lt;li&gt;compatible avec tous les clients HTTP&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Exemple avec curl:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -v -u admin:admin -k https://127.0.0.1:8080/users/toorop@tmail.io
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;requetes:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Requêtes&lt;/h3&gt;

&lt;p&gt;Si il est nécessaire de transmettre des éléments à l&amp;rsquo;API (donc via POST, PUT ou PATCH), ils devront êtres encodés au format JSON.&lt;/p&gt;

&lt;h3 id=&#34;reponses:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Réponses&lt;/h3&gt;

&lt;p&gt;Le corps, si il existe est lui aussi un message JSON.&lt;/p&gt;

&lt;h3 id=&#34;http_code:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Codes HTTP&lt;/h3&gt;

&lt;p&gt;Succès :&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;200 OK: La requête à été exécuté avec succès, la réponse contient un corps.&lt;/li&gt;
&lt;li&gt;201 Created: L&amp;rsquo;entité à été crée.&lt;/li&gt;
&lt;li&gt;204 No Content: La requête à été exécuté avec succès, le corps de la réponse est vide.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Erreurs :&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;400 Bad Request: Le requête est mal formée.&lt;/li&gt;
&lt;li&gt;401 Unauthorized: Une autorisation est nécessaire.&lt;/li&gt;
&lt;li&gt;403 Forbidden: L’accès est refusé.&lt;/li&gt;
&lt;li&gt;404 Not Found: La ressource demandée n&amp;rsquo;existe pas.&lt;/li&gt;
&lt;li&gt;422 Unprocessable Entry: La requête visant à créer ou modifier une entité n&amp;rsquo;a pas pu être exécutée car les données transmises n&amp;rsquo;étaient pas conformes.&lt;/li&gt;
&lt;li&gt;500, 501, 502, 503, etc: Une erreur à eu lieu au niveau du serveur.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;erreurs:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Erreurs&lt;/h3&gt;

&lt;p&gt;En cas d&amp;rsquo;erreur (4** ou 5**), un message sous forme d&amp;rsquo;un objet JSON est retourné.
Le message contient deux champs:
* msg: le message d&amp;rsquo;erreur générée par l&amp;rsquo;application
* raw: l&amp;rsquo;erreur levée (quand elle existe)&lt;/p&gt;

&lt;p&gt;Exemple, si on essaye de créer un utilisateur qui existe déjà:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -H &amp;quot;Content-Type: application/json&amp;quot; -X POST -d &#39;{&amp;quot;passwd&amp;quot;:&amp;quot;motdepasse&amp;quot;,&amp;quot;authRelay&amp;quot;:true,&amp;quot;haveMailbox&amp;quot;:true,&amp;quot;mailboxQuota&amp;quot;:&amp;quot;1G&amp;quot;}&#39; -u admin:admin -k https://127.0.0.1:8080/users/toorop@tmail.io

&amp;lt; HTTP/1.1 422 status code 422
&amp;lt; Content-Type: application/json; charset=UTF-8
&amp;lt; Date: Wed, 01 Apr 2015 15:01:21 GMT
&amp;lt; Content-Length: 85

{&amp;quot;msg&amp;quot;:&amp;quot;unable to create new user&amp;quot;,&amp;quot;raw&amp;quot;:&amp;quot;UNIQUE constraint failed: users.login&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;users:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Gestion des utilisateurs&lt;/h2&gt;

&lt;h3 id=&#34;usersAdd:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Ajouter un utilisateur&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Ressource: /users/LOGIN&lt;/li&gt;
&lt;li&gt;Méthode: POST&lt;/li&gt;
&lt;li&gt;Body:

&lt;ul&gt;
&lt;li&gt;passwd (string): mot de passe de l&amp;rsquo;utilisateur.&lt;/li&gt;
&lt;li&gt;authRelay (bool): défini si l&amp;rsquo;utilisateur peut utiliser tmail pour relayer.&lt;/li&gt;
&lt;li&gt;haveMailbox (bool): défini si l&amp;rsquo;utilisateur à une boite email.&lt;/li&gt;
&lt;li&gt;mailboxQuota (string): le quota de la boite email de l&amp;rsquo;utilisateur en bytes. Vous pouvez utiliser K, M, ou G pour fénir les unités (par exemple 1G signifie un GB)&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Exemple:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -v -u admin:admin -k -H &amp;quot;Content-Type: application/json&amp;quot; -X POST -d &#39;{&amp;quot;passwd&amp;quot;: &amp;quot;mot de passe&amp;quot;, &amp;quot;authRelay&amp;quot;: true, &amp;quot;haveMailbox&amp;quot;: true, &amp;quot;mailboxQuota&amp;quot;: &amp;quot;1G&amp;quot;}&#39; https://127.0.0.1:8080/users/test@tmail.io

&amp;lt; HTTP/1.1 201 Created
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;usersDel:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Supprimer un utilisateur&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Ressource: /users/LOGIN&lt;/li&gt;
&lt;li&gt;Méthode: DELETE&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Exemple:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -v -u admin:admin -k  -X DELETE https://127.0.0.1:8080/users/test@tmail.io

&amp;lt; HTTP/1.1 200 OK
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;usersGetOne:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Retrouver un utilisateur&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Ressource: /users/LOGIN&lt;/li&gt;
&lt;li&gt;Méthode: GET&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Exemple:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -v -u admin:admin -k https://127.0.0.1:8080/users/test@tmail.io

&amp;lt; HTTP/1.1 200 OK
&amp;lt; Content-Type: application/json; charset=UTF-8

{&amp;quot;Id&amp;quot;:10,&amp;quot;Login&amp;quot;:&amp;quot;test@tmail.io&amp;quot;,&amp;quot;Passwd&amp;quot;:&amp;quot;$2a$10$TGg8af6X08KFvWDnjljAqeBpwkXuQ78sc.xyTUrHN6nRzm1wMyIT.&amp;quot;,&amp;quot;DovePasswd&amp;quot;:&amp;quot;$6$06a585cd9d0540d2$OYGaBsyonWxeuoRQkxsokLRkW/vUtx1qbZoEC1DG9DcX7NmHqgrqQtIuL0N6r0RuPpOOhgMdiXPYr/0Dg.wA41&amp;quot;,&amp;quot;Active&amp;quot;:&amp;quot;Y&amp;quot;,&amp;quot;AuthRelay&amp;quot;:true,&amp;quot;HaveMailbox&amp;quot;:true,&amp;quot;MailboxQuota&amp;quot;:&amp;quot;1G&amp;quot;,&amp;quot;Home&amp;quot;:&amp;quot;/home/toorop/Projects/Go/src/github.com/toorop/tmail/dist/mailboxes/t/tmail.io/t/test&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;usersGetAll:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Retrouver tous les utilisateurs&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Ressource: /users&lt;/li&gt;
&lt;li&gt;Méthode: GET&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Exemple:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -v -u admin:admin -k https://127.0.0.1:8080/users

&amp;lt; HTTP/1.1 200 OK
&amp;lt; Content-Type: application/json; charset=UTF-8

[{&amp;quot;Id&amp;quot;:4,&amp;quot;Login&amp;quot;:&amp;quot;texset@tmail.io&amp;quot;,&amp;quot;Passwd&amp;quot;:&amp;quot;$2a$10$rih8MngreLiYl6KzB72jVuufgtIHYFF08c4Q.GNIx2UObPOrL18QW&amp;quot;,&amp;quot;DovePasswd&amp;quot;:&amp;quot;$6$ba3b4fb33607b031$5.FuzhmYBHK5fBIGSMamG7nv7G/OfHxGBuGPBkfSU0FiE6AvWAJIplz/RJP5AQoTFrKC.vYulBeKlKm/Ua7Gj.&amp;quot;,&amp;quot;Active&amp;quot;:&amp;quot;Y&amp;quot;,&amp;quot;AuthRelay&amp;quot;:false,&amp;quot;HaveMailbox&amp;quot;:false,&amp;quot;MailboxQuota&amp;quot;:&amp;quot;&amp;quot;,&amp;quot;Home&amp;quot;:&amp;quot;&amp;quot;},{&amp;quot;Id&amp;quot;:5,&amp;quot;Login&amp;quot;:&amp;quot;texsdet@tmail.io&amp;quot;,&amp;quot;Passwd&amp;quot;:&amp;quot;$2a$10$Lnvy5ViilsKwAKKLsxhrZOhlcZkW.gbDvffEpyEif6Fefc5NU0iOe&amp;quot;,&amp;quot;DovePasswd&amp;quot;:&amp;quot;$6$8c69e981ea71fa91$WRbtGb6AnEKQo.wSRd2VecOkjiHKCr/SVK0ww.qqK/O.wAjLNUn6ztEpONycwFYwiLWU82rI52A8rLzqrNsE./&amp;quot;,&amp;quot;Active&amp;quot;:&amp;quot;Y&amp;quot;,&amp;quot;AuthRelay&amp;quot;:false,&amp;quot;HaveMailbox&amp;quot;:false,&amp;quot;MailboxQuota&amp;quot;:&amp;quot;&amp;quot;,&amp;quot;Home&amp;quot;:&amp;quot;&amp;quot;}]
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;queue:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Gestion de la queue&lt;/h2&gt;

&lt;h3 id=&#34;queueListMessages:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Lister les messages en queue&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Ressource: /queue&lt;/li&gt;
&lt;li&gt;Méthode: GET&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Exemple:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -v -u admin:admin -k https://127.0.0.1:8080/queue

&amp;lt; HTTP/1.1 200 OK
&amp;lt; Content-Type: application/json; charset=UTF-8

[{&amp;quot;Id&amp;quot;:1,&amp;quot;Uuid&amp;quot;:&amp;quot;5217dfdc96d7216d7074b329f88d11f76dee997b&amp;quot;,&amp;quot;Key&amp;quot;:&amp;quot;84855041283d1badc5224231b2afa57f6e1b12e2&amp;quot;,&amp;quot;MailFrom&amp;quot;:&amp;quot;toorop@tmail.io&amp;quot;,&amp;quot;AuthUser&amp;quot;:&amp;quot;toorop@tmail.io&amp;quot;,&amp;quot;RcptTo&amp;quot;:&amp;quot;toorop@toorop.fr&amp;quot;,&amp;quot;MessageId&amp;quot;:&amp;quot;5528C725.8060007@tmail.io&amp;quot;,&amp;quot;Host&amp;quot;:&amp;quot;toorop.fr&amp;quot;,&amp;quot;AddedAt&amp;quot;:&amp;quot;2015-04-11T09:03:02.737629459+02:00&amp;quot;,&amp;quot;NextDeliveryScheduledAt&amp;quot;:&amp;quot;2015-04-11T16:44:35.994411773+02:00&amp;quot;,&amp;quot;Status&amp;quot;:2,&amp;quot;DeliveryFailedCount&amp;quot;:0},{&amp;quot;Id&amp;quot;:2,&amp;quot;Uuid&amp;quot;:&amp;quot;bd36f47dab0e27482ce5db8605415e32978f0185&amp;quot;,&amp;quot;Key&amp;quot;:&amp;quot;38b27d32311b21f1e6afa6215a756c8f696979a8&amp;quot;,&amp;quot;MailFrom&amp;quot;:&amp;quot;toorop@tmail.io&amp;quot;,&amp;quot;AuthUser&amp;quot;:&amp;quot;toorop@tmail.io&amp;quot;,&amp;quot;RcptTo&amp;quot;:&amp;quot;stephane@protecmail.com&amp;quot;,&amp;quot;MessageId&amp;quot;:&amp;quot;5529331C.3050308@tmail.io&amp;quot;,&amp;quot;Host&amp;quot;:&amp;quot;protecmail.com&amp;quot;,&amp;quot;AddedAt&amp;quot;:&amp;quot;2015-04-11T16:43:41.965596115+02:00&amp;quot;,&amp;quot;NextDeliveryScheduledAt&amp;quot;:&amp;quot;0001-01-01T00:09:21+00:09&amp;quot;,&amp;quot;Status&amp;quot;:0,&amp;quot;DeliveryFailedCount&amp;quot;:0}]
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;queueGetMessage:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Récuperer les information concernant un message&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Ressource: /queue/ID&lt;/li&gt;
&lt;li&gt;Méthode: GET&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Exemple:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -v -u admin:admin -k https://127.0.0.1:8080/queue/1

&amp;lt; HTTP/1.1 200 OK
&amp;lt; Content-Type: application/json; charset=UTF-8

{&amp;quot;Id&amp;quot;:1,&amp;quot;Uuid&amp;quot;:&amp;quot;5217dfdc96d7216d7074b329f88d11f76dee997b&amp;quot;,&amp;quot;Key&amp;quot;:&amp;quot;84855041283d1badc5224231b2afa57f6e1b12e2&amp;quot;,&amp;quot;MailFrom&amp;quot;:&amp;quot;toorop@tmail.io&amp;quot;,&amp;quot;AuthUser&amp;quot;:&amp;quot;toorop@tmail.io&amp;quot;,&amp;quot;RcptTo&amp;quot;:&amp;quot;toorop@toorop.fr&amp;quot;,&amp;quot;MessageId&amp;quot;:&amp;quot;5528C725.8060007@tmail.io&amp;quot;,&amp;quot;Host&amp;quot;:&amp;quot;toorop.fr&amp;quot;,&amp;quot;AddedAt&amp;quot;:&amp;quot;2015-04-11T09:03:02.737629459+02:00&amp;quot;,&amp;quot;NextDeliveryScheduledAt&amp;quot;:&amp;quot;2015-04-11T17:15:36.290267337+02:00&amp;quot;,&amp;quot;Status&amp;quot;:2,&amp;quot;DeliveryFailedCount&amp;quot;:0}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;queueDiscardMessage:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Supprimer un message&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Ressource: /queue/discard/ID&lt;/li&gt;
&lt;li&gt;Méthode: DELETE&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Exemple:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -v -u admin:admin -X DELETE -k https://127.0.0.1:8080/queue/discard/1

&amp;lt; HTTP/1.1 200 OK
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;queueBounceMessage:bc6e7d60c7ea3d7165eb78a87a94b626&#34;&gt;Bouncer un message&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Ressource: /queue/bounce/ID&lt;/li&gt;
&lt;li&gt;Méthode: DELETE&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Exemple:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -v -u admin:admin -X DELETE -k https://127.0.0.1:8080/queue/bounce/1

&amp;lt; HTTP/1.1 200 OK
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>Activer l&#39;API REST</title>
      <link>http://tmail.io/doc/activer-api-rest/</link>
      <pubDate>Wed, 01 Apr 2015 15:05:07 +0200</pubDate>
      
      <guid>http://tmail.io/doc/activer-api-rest/</guid>
      <description>

&lt;p&gt;tmail embarque un &lt;a href=&#34;http://fr.wikipedia.org/wiki/Serveur_HTTP&#34; target=&#34;_blank&#34; title=&#34;qu&#39;est ce qu&#39;un serveur HTTP&#34;&gt; serveur HTTP&lt;/a&gt; qui expose une &lt;a href=&#34;http://fr.wikipedia.org/wiki/Representational_State_Transfer&#34; target=&#34;_blank&#34; title=&#34;Qu&#39;est ce qu&#39;une API REST&#34;&gt;API REST&lt;/a&gt;. Cette API vous permet d’administrer votre serveur tmail et &lt;em&gt;&amp;lt;teasing&amp;gt;&lt;/em&gt; dans un futur &amp;ldquo;proche&amp;rdquo; votre cluster SMTP tmail&lt;em&gt;&amp;lt;/teasing&amp;gt;&lt;/em&gt;.&lt;/p&gt;

&lt;h3 id=&#34;activation-et-configuration-de-l-api-rest:82051207c90b1bf3c7ca93b8129f63c7&#34;&gt;Activation et configuration de l&amp;rsquo;API REST.&lt;/h3&gt;

&lt;p&gt;Vous devez d&amp;rsquo;abord spécifier que vous souhaitez activer le service:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Launch REST server
export TMAIL_REST_SERVER_LAUNCH=true
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Puis définir sur quelle IP il doit écouter:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# REST server IP
export TMAIL_REST_SERVER_IP=&amp;quot;127.0.0.1&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Et sur quel port:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# REST server port
export TMAIL_REST_SERVER_PORT=8080
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Ce paramètre vous permet d&amp;rsquo;activer (ou non) le chiffrement de votre connexion:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# REST server is TLS (https) ?
export TMAIL_REST_SERVER_IS_TLS=true
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;tmail va utiliser le certificat dist/ssl/web_server.crt et la clé dist/ssl/web_server.key pour chiffrer les transactions. Vous pouvez utiliser ceux inclus dans la distribution pour vos tests mais attention cela va générer des alertes auprès des clients REST que vous allez utiliser.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Si votre serveur REST écoute sur une IP publique, activer TLS n&amp;rsquo;est pas une option, c&amp;rsquo;est impératif car l&amp;rsquo;authentification se fait avec des mots de passe en clair  &lt;a href=&#34;http://fr.wikipedia.org/wiki/Authentification_HTTP#M.C3.A9thode_.C2.AB_Basic_.C2.BB&#34; target=&#34;_blank&#34;&gt;(authentification HTTP Basic)&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Enfin vous devez définir vos identifiants de connexion:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Login for HTTP auth
export TMAIL_REST_SERVER_LOGIN=&amp;quot;admin&amp;quot;

# Passwd for HTTP auth
export TMAIL_REST_SERVER_PASSWD=&amp;quot;admin&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;test:82051207c90b1bf3c7ca93b8129f63c7&#34;&gt;Test&lt;/h4&gt;

&lt;p&gt;Après avoir relancé tmail vous devriez voir dans vos logs une ligne de ce type:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[trooper - 127.0.0.1] 2015/04/01 15:32:06.467484 INFO - httpd 127.0.0.1:8080 TLS launched
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Vous pouvez tester le fonctionnement de l&amp;rsquo;API en appelant la ressource /ping. Par exemple avec &lt;a href=&#34;http://curl.haxx.se/&#34; target=&#34;_blank&#34; title=&#34;tester une API REST avec curl&#34;&gt;curl&lt;/a&gt; :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ curl -k https://127.0.0.1:8080/ping
{&amp;quot;msg&amp;quot;: &amp;quot;pong&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;La ligne de log correspondant à cette requête :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[trooper - 127.0.0.1] 2015/04/02 11:09:51.647899 INFO - http 127.0.0.1:54423 - GET /ping - 200 OK 4.638µs
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;em&gt;Note: Non il n&amp;rsquo;y à pas d&amp;rsquo;erreur la requête à bien mis 0.000004 seconde pour être exécutée ;-)&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&#34;généralités:82051207c90b1bf3c7ca93b8129f63c7&#34;&gt;Généralités&lt;/h2&gt;

&lt;h3 id=&#34;authentification:82051207c90b1bf3c7ca93b8129f63c7&#34;&gt;Authentification&lt;/h3&gt;

&lt;p&gt;L&amp;rsquo;API utilise l&amp;rsquo;authentification &lt;a href=&#34;http://fr.wikipedia.org/wiki/Authentification_HTTP#M.C3.A9thode_.C2.AB_Basic_.C2.BB&#34; target=&#34;_blank&#34;&gt;HTTP Basic&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Pourquoi ce type d’authentification ?&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;simple à mettre en œuvre&lt;/li&gt;
&lt;li&gt;compatible avec tous les clients HTTP&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;requêtes:82051207c90b1bf3c7ca93b8129f63c7&#34;&gt;Requêtes&lt;/h3&gt;

&lt;p&gt;Si il est nécessaire de transmettre des éléments à l&amp;rsquo;API (donc via POST, PUT ou PATCH), ils devront êtres encodés au format JSON.&lt;/p&gt;

&lt;h3 id=&#34;réponses:82051207c90b1bf3c7ca93b8129f63c7&#34;&gt;Réponses&lt;/h3&gt;

&lt;p&gt;Le corps, si il existe est lui aussi un message JSON.&lt;/p&gt;

&lt;h3 id=&#34;codes-http:82051207c90b1bf3c7ca93b8129f63c7&#34;&gt;Codes HTTP&lt;/h3&gt;

&lt;p&gt;Succès :&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;200 OK: La requête à été exécuté avec succès, la réponse contient un corps.&lt;/li&gt;
&lt;li&gt;201 Created: L&amp;rsquo;entité à été crée.&lt;/li&gt;
&lt;li&gt;204 No Content: La requête à été exécuté avec succès, le corps de la réponse est vide.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Erreurs :&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;400 Bad Request: Le requête est mal formée.&lt;/li&gt;
&lt;li&gt;401 Unauthorized: Une autorisation est nécessaire.&lt;/li&gt;
&lt;li&gt;403 Forbidden: L’accès est refusé.&lt;/li&gt;
&lt;li&gt;404 Not Found: La ressource demandée n&amp;rsquo;existe pas.&lt;/li&gt;
&lt;li&gt;422 Unprocessable Entry: La requête visant à créer ou modifier une entité n&amp;rsquo;a pas pu être exécutée car les données transmises n&amp;rsquo;étaient pas conformes.&lt;/li&gt;
&lt;li&gt;500, 501, 502, 503, etc: Une erreur à eu lieu au niveau du serveur.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;erreurs:82051207c90b1bf3c7ca93b8129f63c7&#34;&gt;Erreurs&lt;/h3&gt;

&lt;p&gt;En cas d&amp;rsquo;erreur (4** ou 5**), un message sous forme d&amp;rsquo;un objet JSON est retourné.
Le message contient deux champs:
* msg: le message d&amp;rsquo;erreur générée par l&amp;rsquo;application
* raw: l&amp;rsquo;erreur levée (quand elle existe)&lt;/p&gt;

&lt;p&gt;Exemple, si on essaye de créer un utilisateur qui existe déjà:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -H &amp;quot;Content-Type: application/json&amp;quot; -X POST -d &#39;{&amp;quot;passwd&amp;quot;:&amp;quot;motdepasse&amp;quot;,&amp;quot;authRelay&amp;quot;:true,&amp;quot;haveMailbox&amp;quot;:true,&amp;quot;mailboxQuota&amp;quot;:&amp;quot;1G&amp;quot;}&#39; -u admin:admin -k https://127.0.0.1:8080/users/toorop@tmail.io

&amp;lt; HTTP/1.1 422 status code 422
&amp;lt; Content-Type: application/json; charset=UTF-8
&amp;lt; Date: Wed, 01 Apr 2015 15:01:21 GMT
&amp;lt; Content-Length: 85

{&amp;quot;msg&amp;quot;:&amp;quot;unable to create new user&amp;quot;,&amp;quot;raw&amp;quot;:&amp;quot;UNIQUE constraint failed: users.login&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>Gestion des logs tmail</title>
      <link>http://tmail.io/doc/logs/</link>
      <pubDate>Fri, 27 Mar 2015 14:03:12 +0100</pubDate>
      
      <guid>http://tmail.io/doc/logs/</guid>
      <description>&lt;p&gt;Par défaut tmail va afficher les logs sur la sortie standard &lt;em&gt;stdout&lt;/em&gt;.&lt;br /&gt;
Vous pouvez configurer tmail pour qu&amp;rsquo;il enregistre les logs dans un fichier texte.&lt;/p&gt;

&lt;p&gt;Pour cela, éditer le fichier de configuration et modifiez la variable &lt;em&gt;TMAIL_LOGPATH&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;Pour enregistrer les logs dans le dossier &lt;em&gt;/home/tmail/dist/log/&lt;/em&gt; :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;export TMAIL_LOGPATH=&amp;quot;/home/tmail/dist/log/&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;Attention&lt;/strong&gt; le dossier doit exister, et l&amp;rsquo;utilisateur sous lequel est lancé tmail doit avoir les droits de lecture et d&amp;rsquo;écriture sur ce dossier.&lt;/p&gt;

&lt;p&gt;Pour revenir vers un affichage des logs vers la sortie standard, mettez &lt;em&gt;stdout&lt;/em&gt; à la place du chemin:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;export TMAIL_LOGPATH=&amp;quot;stdout&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;La verbosité des logs se configure via la variable &lt;em&gt;TMAIL_DEBUG_ENABLED&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;En la mettant à &lt;em&gt;true&lt;/em&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;export TMAIL_DEBUG_ENABLED=true
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;vous aurez un maximum de logs. Attention ce mode est très verbeux, si vous n&amp;rsquo;avez pas de problèmes particuliers je vous recommande de mettre cette variable à &lt;em&gt;false&lt;/em&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;export TMAIL_DEBUG_ENABLED=false
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;dans ce mode vous aurez les logs nécessaires au suivi de la bonne marche de votre serveur mail.&lt;/p&gt;

&lt;p&gt;Voici un exemple de logs avec TMAIL_DEBUG_ENABLED positionné à false:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[mail.tmail.io - 127.0.0.1] 2015/03/27 15:11:56.689099 INFO - smtpd  ba06fea8e42ee38d62cdb82c98a5221e6e7852cd - 88.178.118.205:50348 - starting new transaction
[mail.tmail.io - 127.0.0.1] 2015/03/27 15:11:56.717078 INFO - smtpd  ba06fea8e42ee38d62cdb82c98a5221e6e7852cd - 88.178.118.205:50348 - remote greets as [192.168.0.1]
[mail.tmail.io - 127.0.0.1] 2015/03/27 15:11:57.001558 INFO - smtpd  ba06fea8e42ee38d62cdb82c98a5221e6e7852cd - 88.178.118.205:50348 - remote greets as [192.168.0.1]
[mail.tmail.io - 127.0.0.1] 2015/03/27 15:11:57.138727 INFO - smtpd  ba06fea8e42ee38d62cdb82c98a5221e6e7852cd - 88.178.118.205:50348 - auth succeed for user toorop@tmail.io
[mail.tmail.io - 127.0.0.1] 2015/03/27 15:11:57.164773 INFO - smtpd  ba06fea8e42ee38d62cdb82c98a5221e6e7852cd - 88.178.118.205:50348 - new mail from toorop@tmail.io
[mail.tmail.io - 127.0.0.1] 2015/03/27 15:11:57.192105 INFO - smtpd  ba06fea8e42ee38d62cdb82c98a5221e6e7852cd - 88.178.118.205:50348 - rcpt to: toorop@toorop.fr
[mail.tmail.io - 127.0.0.1] 2015/03/27 15:11:57.267349 INFO - smtpd  ba06fea8e42ee38d62cdb82c98a5221e6e7852cd - 88.178.118.205:50348 - Message-ID: &amp;lt;5515651A.4000304@tmail.io&amp;gt;
[mail.tmail.io - 127.0.0.1] 2015/03/27 15:11:57.305726 INFO - smtpd  ba06fea8e42ee38d62cdb82c98a5221e6e7852cd - 88.178.118.205:50348 - message queued as 3b0d652314a64d906b61a9658362f4d126400015
[mail.tmail.io - 127.0.0.1] 2015/03/27 15:11:57.331292 INFO - smtpd  ba06fea8e42ee38d62cdb82c98a5221e6e7852cd - 88.178.118.205:50348 - EOT
[mail.tmail.io - 127.0.0.1] 2015/03/27 15:11:57.332438 INFO - delivery-remote 30316f400ef44fe563dd2b8b9c06807124b32d75: starting new delivery from toorop@tmail.io to toorop@toorop.fr - Message-Id: &amp;lt;5515651A.4000304@tmail.io&amp;gt; - Queue-Id: 3b0d652314a64d906b61a9658362f4d126400015
[mail.tmail.io - 127.0.0.1] 2015/03/27 15:12:01.396618 INFO - deliverd-remote 30316f400ef44fe563dd2b8b9c06807124b32d75: remote server 178.33.223.34 reply to data cmd: 250 - ok
[mail.tmail.io - 127.0.0.1] 2015/03/27 15:12:01.396819 INFO - deliverd 30316f400ef44fe563dd2b8b9c06807124b32d75: success
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>Gérez vos boites mail avec Dovecot</title>
      <link>http://tmail.io/doc/mailboxes/</link>
      <pubDate>Fri, 20 Mar 2015 16:34:28 +0100</pubDate>
      
      <guid>http://tmail.io/doc/mailboxes/</guid>
      <description>

&lt;p&gt;Initialement j&amp;rsquo;avais prévu d&amp;rsquo;ajouter le support de comptes mail bien plus tard dans le cycle de développement car mon usage principal de tmail est avant tout celui de relais SMTP.&lt;br /&gt;
Le fait que l&amp;rsquo;on m&amp;rsquo;ait demandé si ça allait être bientôt disponible m&amp;rsquo;a fait réaliser que gérer des comptes mails était quand même l&amp;rsquo;usage principal d&amp;rsquo;un serveur de messagerie - gnééééé&amp;hellip; - , j&amp;rsquo;ai donc décidé de remonter cette tache dans ma todo-list.&lt;/p&gt;

&lt;p&gt;Pour vous proposer cette fonctionnalité plus rapidement, j&amp;rsquo;ai fait quelques compromis par rapport à ce que je voulais initialement faire. Mon idée de départ était de ne pas utiliser le classique stockage des mails via Mailbox/maildir + accès POP ou IMAP, mais d’utiliser une &lt;strong&gt;interface de stockage de type PUT/GET pour stocker les mails et une API HTTP REST pour y accéder et les gérer.&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;L’intérêt de cette solution c&amp;rsquo;est que l&amp;rsquo;on peut implémenter l&amp;rsquo;interface pour une multitude de types de stockage, du simple espace disque sur le serveur, ou déporté sur un NAS/Filer, mais aussi du Amazon S3, ou encore du Runabove.
Par ailleurs proposer une API REST pour gérer les mails permettait de développer simplement des clients de messagerie, des &amp;ldquo;connecteurs/proxy&amp;rdquo; pour rendre ce stockage compatible avec les clients classique (par exemple un proxy IMAP), mais aussi d&amp;rsquo;interfacer simplement de nombreux outils au service de messagerie.&lt;/p&gt;

&lt;p&gt;Rassurez vous - ou pas - je n&amp;rsquo;ai pas abandonné ces idées, ce sera implémenté, mais en attendant pour offrir le plus rapidement la possibilité d&amp;rsquo;utiliser tmail comme serveur mail classique, j&amp;rsquo;ai décidé de prendre un raccourci en implémentant le nécessaire pour utiliser Dovecot avec tmail.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Concrètement il est donc aujourd&amp;rsquo;hui possible d&amp;rsquo;utiliser tmail comme serveur de destination pour un domaine - celui qui va héberger les mails du domaine donc - et d&amp;rsquo;accéder aux boites mails via POP et IMAP.&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Voila pour cette - longue - introduction, passons à la pratique.&lt;/p&gt;

&lt;h2 id=&#34;mise-en-œuvre:4002a66b7442538ff5ec29eb457b2fec&#34;&gt;Mise en œuvre&lt;/h2&gt;

&lt;h3 id=&#34;pre-requis:4002a66b7442538ff5ec29eb457b2fec&#34;&gt;Pre-requis&lt;/h3&gt;

&lt;p&gt;Je vais utiliser une distribution Ubuntu server 14.10, si vous utilisez une distribution Debian ou dérivée l&amp;rsquo;installation devrait être sensiblement la même.&lt;/p&gt;

&lt;p&gt;On commence par s&amp;rsquo;assurer que notre système est a jour:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;apt-get update &amp;amp;&amp;amp; apt-get upgrade
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Si l’utilisateur tmail n&amp;rsquo;existe pas, on va le créer:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;adduser tmail
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;installation-de-dovecot:4002a66b7442538ff5ec29eb457b2fec&#34;&gt;Installation de Dovecot&lt;/h3&gt;

&lt;p&gt;On va commencer par la base, en fin d&amp;rsquo;article vous trouverez comment ajouter le support de sieve:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;apt-get install dovecot-imapd dovecot-pop3d
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Il va vous être demandé si vous souhaitez créer un certificat SSL, répondez &lt;em&gt;oui&lt;/em&gt;, cela va générer un certificat auto-signé.&lt;/p&gt;

&lt;p&gt;Il va maintenant falloir installer le support de base de données pour que Dovecot puisse se connecter à la base de données utilisée par tmail. Il faudra donc en fonction de vos besoins installer soit dovecot-sqlite si vous utilisez SQLite, soit dovecot-mysql si vous utilisez MySQL,soit dovecot-pgsql si vous utilisez PostgreSQL.&lt;/p&gt;

&lt;p&gt;Dans mon cas comme je vais avoir besoin de tester sur les 3 SGDB, j&amp;rsquo;installe les donc trois:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;apt-get install dovecot-sqlite dovecot-mysql dovecot-pgsql
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;On va en rester là pour le moment, on ferra la configuration après avoir installé tmail.&lt;/p&gt;

&lt;h3 id=&#34;installation-de-tmail:4002a66b7442538ff5ec29eb457b2fec&#34;&gt;Installation de tmail&lt;/h3&gt;

&lt;p&gt;Si vous avez déjà tmail installé, je vous recommande de supprimer les tables de votre base de données.
Beaucoup de modifications on été faites et il est plus prudent de repartir de zéro.&lt;/p&gt;

&lt;p&gt;Suivez ce tutoriel pour &lt;a href=&#34;http://tmail.io/doc/installer-tmail/&#34;&gt;installer tmail&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;configuration-de-tmail:4002a66b7442538ff5ec29eb457b2fec&#34;&gt;Configuration de tmail&lt;/h3&gt;

&lt;p&gt;Nous avons besoin de configurer trois paramètres&lt;/p&gt;

&lt;p&gt;Le répertoire dans lequel seront stockés les boites mails, par défaut c&amp;rsquo;est /home/tmail/dist/mailboxes.&lt;br /&gt;
Assurez vous que l&amp;rsquo;utilisateur tmail ait les droits de lecture et d&amp;rsquo;écriture sur ce répertoire.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Base path for users &amp;quot;home&amp;quot;. Currently ysed to store mailboxes
export TMAIL_USERS_HOME_BASE=&amp;quot;/home/tmail/dist/mailboxes&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;On doit ensuite activer le support de Dovecot:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Enabled dovecot for local deliveries
export TMAIL_DOVECOT_SUPPORT_ENABLED=true
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Et enfin indiquer à tmail où se trouve l&amp;rsquo;agent de livraison dovecot-lda:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Dovecot LDA path
export TMAIL_DOVECOT_LDA=&amp;quot;/usr/lib/dovecot/dovecot-lda&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;création-d-une-boite-mail:4002a66b7442538ff5ec29eb457b2fec&#34;&gt;Création d&amp;rsquo;une boite mail&lt;/h3&gt;

&lt;p&gt;Dans cet exemple tmail devra gérer les boites du domaine tmail.io.
Si dans votre cas vous avez déjà utilisé le domaine sur lequel vous souhaitez créer des boites vous devez le supprimer car le cli ne permet pas pour le moment de modifier la configuration d&amp;rsquo;un domaine.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tmail rcpthost del tmail.io
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;On crée le compte toorop@tmail.io avec l&amp;rsquo;option &lt;em&gt;-m&lt;/em&gt; pour signifier à tmail que cet utilisateur aura une boite mail et avec l’option &lt;em&gt;-r&lt;/em&gt; pour lui indiquer que cet utilisateur pourra utiliser tmail comme relais SMTP (après authentification).&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tmail user add -m -r toorop@tmail.io MOT_DE_PASSE
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;configuration-de-dovecot:4002a66b7442538ff5ec29eb457b2fec&#34;&gt;Configuration de Dovecot&lt;/h3&gt;

&lt;p&gt;La première chose à faire est d&amp;rsquo;augmenter au maximum les niveaux de logs, comme ça si il y a un problème ce sera plus facile de le localiser.&lt;/p&gt;

&lt;p&gt;Pour cela on édite le ficher &lt;em&gt;/usr/share/dovecot/conf.d/10-logging.conf&lt;/em&gt; et on modifie les parametres suivant:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;auth_verbose = yes
auth_debug = yes
auth_debug_passwords = yes
mail_debug = yes
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;On va à présent devoir indiquer à Dovecot comment allez récupérer les informations sur les utilisateurs.
Pour cela on va lui indiquer la requête SQL qu&amp;rsquo;il doit exécuter.
On édite le fichier: &lt;em&gt;/etc/dovecot/dovecot-sql.conf.ext&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;Il faut d&amp;rsquo;abord spécifier le driver que l&amp;rsquo;on va utiliser, dans mon cas sqlite:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Database driver: mysql, pgsql, sqlite
driver = sqlite
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Ensuite la &amp;ldquo;connection string&amp;rdquo;, autrement dit les indications qui vont permettre à Dovecot de se connecter à la base de données tmail:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;connect = /home/tmail/dist/db/tmail.db   
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;l&amp;rsquo;algorithme utilisé pour &amp;ldquo;hasher&amp;rdquo; les mots de passe:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;default_pass_scheme = SHA512-CRYPT
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;La requête pour réaliser une authentification:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;password_query = SELECT login AS user, dove_passwd AS password \
FROM users WHERE login = &#39;%u&#39; AND active = &#39;Y&#39;  
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Pour la requête suivante, celle qui va permettre à Dovecot de récupérer des informations sur l&amp;rsquo;utilisateur, on va avoir besoin de connaître les UID/GID de l&amp;rsquo;utilisateur tmail sur votre système, pour cela exécuter en root la commande suivante:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cat /etc/passwd | grep tmail
tmail:x:1000:1000:,,,:/home/tmail:/bin/bash
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Dans mon cas l&amp;rsquo;UID de tmail est 1000 son GID est aussi 1000.&lt;/p&gt;

&lt;p&gt;Cette requête va varier en fonction du SGDB que vous utilisez, si vous utilisez SQLite ou PostgreSQL utilisez cette requête:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;user_query = SELECT 1000 AS uid, 1000 AS gid, home, \
&#39;*:bytes=&#39; || mailbox_quota AS quota_rule \
FROM users WHERE login = &#39;%u&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;si vous utilisez MySQL:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;user_query = SELECT 1000 as uid, 1000 as gid, home, \
concat(&#39;*:bytes=&#39;, mailbox_quota) AS quota_rule \
FROM users WHERE login = &#39;%u&#39;   
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Il faut à présent spécifier à Dovecot que l&amp;rsquo;on souhaite utiliser l’authentification via SQL, on édite &lt;em&gt;/etc/dovecot/conf.d/10-auth.conf&lt;/em&gt; et on commente :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#!include auth-system.conf.ext
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;et on dé-commente:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;!include auth-sql.conf.ext
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Ensuite &lt;strong&gt;on configure l&amp;rsquo;agent de livraison dovecot-lda&lt;/strong&gt;, en éditant le fichier &lt;em&gt;/etc/dovecot/conf.d/15-lda.conf&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;L&amp;rsquo;adresse postmaster: cette adresse va être, entre utilisée, si EDovecot à besoin d&amp;rsquo;envoyer des mails pour informer d&amp;rsquo;un problème. Par exemple pour bouncer un mail. Il va sans dire que cette adresse doit exister et je vous recommande fortement d&amp;rsquo;utiliser une adresse du type postmaster@domain (on pourra utiliser un alias quand ce sera implémenté en attendant créez une boite via &lt;em&gt;tmail user add -m postmaster@tmail.io MOT_DE_PASSE&lt;/em&gt;).&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;postmaster_address = postmaster@tmail.io
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Dovecot doit pouvoir utiliser tmail pour envoyer des mails, par exemple les bounces évoqués au dessus, on va donc le configurer pour:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;submission_host = 127.0.0.1:2525        
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Bien entendu il faut que dans votre configuration vous ayez dit à tmail d&amp;rsquo;écouter, entre autre, sur l&amp;rsquo;IP 127.0.0.1 et sur le port 2525 (&lt;em&gt;export TMAIL_SMTPD_DSNS=&amp;ldquo;127.0.0.1:2525:false;IP:PORT:true&amp;rdquo;&lt;/em&gt; par exemple) et il faut également que l&amp;rsquo;IP qui va contacter tmail soit autorisée à relayer, pour ça il vous suffit d’exécuter la commande :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tmail relayip add 127.0.0.1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Il nous faut à présent &lt;strong&gt;configurer le format de stockage des boites mails&lt;/strong&gt;, on va utiliser Maildir.&lt;br /&gt;
On édite le fichier  &lt;em&gt;/etc/dovecot/conf.d/10-mail.conf&lt;/em&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;mail_location = maildir:~/Maildir
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;On va activer les quotas&lt;/strong&gt;, ce n&amp;rsquo;est pas une obligation mais je vous recommande fortement de le faire sinon vous courrez le risque de voir votre partition saturée si vous veniez à recevoir de nombreux mails.&lt;/p&gt;

&lt;p&gt;Toujours dans le fichier &lt;em&gt;/etc/dovecot/conf.d/10-mail.conf&lt;/em&gt; :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;mail_plugins = $mail_plugins quota
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Il nous faut aussi l&amp;rsquo;activer pour IMAP ce qui va nous permettre de connaître l&amp;rsquo;usage de la boite mail depuis le client IMAP. On édite le fichier &lt;em&gt;/etc/dovecot/conf.d/20-imap.conf&lt;/em&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Space separated list of plugins to load (default is global mail_plugins).
mail_plugins = $mail_plugins quota imap_quota
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;et dire à Dovecot ce qu&amp;rsquo;il doit utiliser comme méthode pour calculer les quotas. Ici on va faire au plus simple, il va directement regarder l&amp;rsquo;espace disque utilisé.&lt;br /&gt;
Éditez  &lt;em&gt;/etc/dovecot/conf.d/90-quota.conf&lt;/em&gt; et de-commentez la ligne:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;quota = dirsize:User quota  
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Coté client, si vous utilisez Thunderbird voici&lt;a href=&#34;https://addons.mozilla.org/fr/thunderbird/addon/display-quota/?src=search&#34; target=&#34;_blank&#34;&gt;un plugin vous permettant d&amp;rsquo;afficher le quota de votre boite mail&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Voila c&amp;rsquo;est fini, il ne vous reste plus qu&amp;rsquo;a relancer Dovecot:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;service dovecot restart
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Normalement tout devrait fonctionner, si ce n&amp;rsquo;est pas le cas, consultez les logs de Dovecot et de tmail, et si vous n&amp;rsquo;arriver pas à résoudre le problème, postez un SOS en commentaire de cet article (si ça fonctionne vous pouvez aussi laisser un commentaire ;))&lt;/p&gt;

&lt;p&gt;Si tout fonctionne correctement penser à réduire le niveau de log de Dovecot.&lt;/p&gt;

&lt;h2 id=&#34;sieve:4002a66b7442538ff5ec29eb457b2fec&#34;&gt;Sieve&lt;/h2&gt;

&lt;p&gt;Ce qui suit n&amp;rsquo;est pas du tout indispensable, mais puisque vous avez les mains dans le cambouis je vous encourage à faire encore un petit effort, vous ne le regretterez pas.&lt;/p&gt;

&lt;h3 id=&#34;qu-est-ce-que-sieve:4002a66b7442538ff5ec29eb457b2fec&#34;&gt;Qu&amp;rsquo;est ce que Sieve ?&lt;/h3&gt;

&lt;p&gt;Je vais reprendre la &lt;a href=&#34;http://fr.wikipedia.org/wiki/Sieve&#34; target=&#34;_blank&#34;&gt; définition donnée par Wikipédia &lt;/a&gt;:
&lt;blockquote cite=&#34;http://fr.wikipedia.org/wiki/Sieve&#34;&gt;Sieve (du mot anglais crible comme dans le crible d&amp;rsquo;Ératosthène) est un langage de filtrage du courrier électronique. Il est normalisé dans le RFC 5228. Sieve permet de filtrer sur les en-têtes d&amp;rsquo;un message qui suit le format du RFC 5322, c&amp;rsquo;est-à-dire un message Internet typique.&lt;/blockquote&gt;&lt;/p&gt;

&lt;p&gt;Dans notre cas, Sieve va être utilisé par l&amp;rsquo;agent de livraison, dovecot-lda, il va nous permettre, entre autre, de classer les mails dans différents dossiers. Je vous donnerais quelques exemples plus bas.&lt;/p&gt;

&lt;h3 id=&#34;installation-de-du-plugin-sieve-et-de-managesieve:4002a66b7442538ff5ec29eb457b2fec&#34;&gt;Installation de du plugin sieve et de manageSieve&lt;/h3&gt;

&lt;p&gt;ManageSieve est un serveur qui va vous permettre de modifier vos règles Sieve depuis votre client de messagerie. Bien entendu il faut que le client le supporte.&lt;/p&gt;

&lt;p&gt;Sur Debian et dérivés un simple:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;apt-get install dovecot-sieve dovecot-managesieved
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;va vous installer le nécessaire.&lt;/p&gt;

&lt;p&gt;Pour les autres je vous renvoie vers &lt;a href=&#34;http://wiki2.dovecot.org/Pigeonhole/Sieve&#34; target=&#34;_blank&#34;&gt;la documentation officielle de Pigeonhole Sieve&lt;/a&gt; où vous trouverez le nécessaire pour installer le plugin Sieve et ManageSieve.&lt;/p&gt;

&lt;h3 id=&#34;configuration:4002a66b7442538ff5ec29eb457b2fec&#34;&gt;Configuration&lt;/h3&gt;

&lt;p&gt;On édite le fichier &lt;em&gt;/etc/dovecot/conf.d/15-lda.conf&lt;/em&gt; pour signifier à dovecot qu&amp;rsquo;il doit charger le plugin Sieve:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;   mail_plugins = $mail_plugins sieve
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Il faut que l&amp;rsquo;agent de livraison soit capable de créer un sous dossier si il n&amp;rsquo;existe pas:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;lda_mailbox_autocreate = yes    
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;On va aussi activer l&amp;rsquo;abonnement automatique aux dossiers créés:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;lda_mailbox_autosubscribe = yes    
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Le fichier de configuration de sieve est &lt;em&gt;/etc/dovecot/conf.d/90-sieve.conf&lt;/em&gt;, la configuration par défaut est suffisante, on ne va donc rien modifier. Je vous invite quand même à y jeter un œil.&lt;/p&gt;

&lt;p&gt;Pour ManageSieve, le fichier de configuration est &lt;em&gt;/etc/dovecot/conf.d/30-managesieve.conf&lt;/em&gt; et comme pour sieve la configuration par défaut nous convient.&lt;/p&gt;

&lt;p&gt;Vous pouvez relancer dovecot.&lt;/p&gt;

&lt;h3 id=&#34;quelques-exemples-d-utilisation-de-sieve:4002a66b7442538ff5ec29eb457b2fec&#34;&gt;Quelques exemples d&amp;rsquo;utilisation de Sieve&lt;/h3&gt;

&lt;p&gt;Si comme moi vous utiliser Thunderbird comme client mail, n&amp;rsquo;utilise pas le module Sieve présent sur le repo Mozilla, cette version ne fonctionne pas avec les version récente de Thunderbird. &lt;a href=&#34;https://github.com/thsmi/sieve/tree/master/nightly/&#34;&gt;téléchargez la dernière version du plugin ManageSieve pour thunderbird ici&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;En début de script ajoutez :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;require &amp;quot;fileinto&amp;quot;;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Classer les messages de la mailing-list bar@ovh.net dans le dossier Inbox/ml/bar@ovh&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;if address :is [&amp;quot;To&amp;quot;,&amp;quot;Cc&amp;quot;] &amp;quot;bar@ml.ovh.net&amp;quot; {
    fileinto &amp;quot;ml.bar@ovh&amp;quot;;
    stop;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Classer les spams dans un dossier Inbox/Spams si le sujet commence par [SPAM]&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;if header :comparator &amp;quot;i;ascii-casemap&amp;quot; :contains &amp;quot;Subject&amp;quot; &amp;quot;[SPAM]&amp;quot;  {
    fileinto &amp;quot;spams&amp;quot;;
    stop;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Pour aller plus loin, voici &lt;a href=&#34;http://wiki2.dovecot.org/Pigeonhole/Sieve/Examples&#34; target=&#34;_blank&#34;&gt; des exemples de scripts Sieve &lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Filtrage antivirus en utilisant Clamav</title>
      <link>http://tmail.io/doc/filtrage-smtp-antivirus-clamav/</link>
      <pubDate>Wed, 18 Feb 2015 14:19:22 +0100</pubDate>
      
      <guid>http://tmail.io/doc/filtrage-smtp-antivirus-clamav/</guid>
      <description>

&lt;p&gt;Vous trouverez dans ce billet les explications nécessaires pour installer l&amp;rsquo;antivirus opensource &lt;a href=&#34;http://www.clamav.net/index.html&#34;&gt;Clamav&lt;/a&gt; et activer le filtrage de votre flux SMTP par tmail.&lt;/p&gt;

&lt;h3 id=&#34;installation-de-clamav:7da83a8da26892e0f6b1ccff72984fde&#34;&gt;Installation de clamav&lt;/h3&gt;

&lt;p&gt;Je vais prendre le cas où vous utilisez une distribution Linux Debian ou Ubuntu, dans ce cas l’installation de Clamav est on ne peut plus simple :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo apt-get install clamav
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Comme tout antivirus il est nécessaire de maintenir à jour la base de signatures du scanner, normalement l&amp;rsquo;installation de Clamav va aussi entraîner l&amp;rsquo;installation de l&amp;rsquo;outil &lt;em&gt;freshclam&lt;/em&gt; dédié à cet effet.&lt;/p&gt;

&lt;p&gt;Il ne nous reste plus qu&amp;rsquo;à lancer les services, le scanner en tant que tel:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo service clamav-daemon start
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;et le daemon freshclam qui va maintenir à jour la base de signatures:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo service clamav-freshclam start
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;configuration-de-tmail-pour-activer-le-filtrage-antivirus:7da83a8da26892e0f6b1ccff72984fde&#34;&gt;Configuration de tmail pour activer le filtrage antivirus&lt;/h3&gt;

&lt;p&gt;Il y à deux paramètres à configurer/vérifier pour activer le filtrage de votre flux SMTP. Tout d&amp;rsquo;abord il faut indiquer à tmail le socket unix sur lequel écoute le scanner. Le fichier de config contient le chemin par défaut lors d&amp;rsquo;une installation sous Ubuntu, si vous n&amp;rsquo;utilisez pas cette distribution, vous trouverez le chemin dans votre fichier de configuration de clamav.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Clamd DSNS
export TMAIL_SMTPD_SCAN_CLAMAV_DSNS=&amp;quot;/var/run/clamav/clamd.ctl&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Ensuite il ne reste plus qu&amp;rsquo;a activer le filtrage:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Clamav
export TMAIL_SMTPD_SCAN_CLAMAV_ENABLED=true
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Et voila !&lt;/p&gt;

&lt;p&gt;Il faut savoir qu&amp;rsquo;actuellement le comportement va être le suivant:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Les mails vont êtres filtrés durant la transaction SMTP.&lt;/li&gt;
&lt;li&gt;Si un virus est détecté le mail va être refusé.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;A terme je pense ajouter des option permettant par exemple de taguer les mails.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Installer et configurer tmail</title>
      <link>http://tmail.io/doc/installer-tmail/</link>
      <pubDate>Thu, 29 Jan 2015 17:00:44 +0100</pubDate>
      
      <guid>http://tmail.io/doc/installer-tmail/</guid>
      <description>

&lt;p&gt;&lt;br&gt;
&lt;div style=&#34;text-align:center&#34;&gt;
&lt;iframe align=&#34;center&#34; width=&#34;640&#34; height=&#34;360&#34; src=&#34;https://www.youtube.com/embed/Ncs3AZKPqKU?rel=0&#34; frameborder=&#34;0&#34; allowfullscreen&gt;&lt;/iframe&gt;
&lt;/div&gt;
&lt;br&gt;&lt;/p&gt;

&lt;p&gt;Durant tout le cycle de développement de tmail je vais mettre à disposition le nécessaire pour qu&amp;rsquo;il soit possible de tester les fonctionnalités qui sont implémentées.&lt;/p&gt;

&lt;p&gt;Qu&amp;rsquo;il n&amp;rsquo;y ait pas de malentendu, on ne parle pas ici de version bêta, ni même alpha, ce sera à chaque fois une version de développement, avec plein de choses non implémentées et forcement de nombreux bugs.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;En clair: ne pas utiliser en production&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Pour le moment tmail est très basique, mais il devrait cependant vous permettre d&amp;rsquo;envoyer et de relayer des mails.&lt;/p&gt;

&lt;p&gt;On va partir sur une installation qui va nous permettre de mettre en place un service SMTP qui va:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;écouter sur les ports 25 et 587 (avec STARTTLS).&lt;/li&gt;
&lt;li&gt;écouter sur le port 465 en SSL.&lt;/li&gt;
&lt;li&gt;accepter tous les mails à destination du domaine &lt;em&gt;toorop.fr&lt;/em&gt; et qui va les router vers &lt;em&gt;mail.toorop.fr&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;permettre à l&amp;rsquo;utilisateur &lt;em&gt;toorop@toorop.fr&lt;/em&gt; ayant comme mot de passe &lt;em&gt;password&lt;/em&gt; d&amp;rsquo;utiliser le service pour envoyer des mails (quelque soit la destination).&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;prérequis:b68dafd7755f74812ae92f74ce38ff42&#34;&gt;Prérequis&lt;/h2&gt;

&lt;p&gt;Vous n&amp;rsquo;avez donc besoin de rien d&amp;rsquo;autre pour tester qu&amp;rsquo;une machine sous Linux. Pour cet exemple je vais utiliser un &lt;a href=&#34;https://www.ovh.com/fr/vps/vps-classic.xml&#34;&gt;VPS Classic 1 OVH&lt;/a&gt; sous &lt;em&gt;Ubuntu server 64bits&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;Pensez à vous assurer que vous pouvez utiliser les ports SMTP (ou alors testez sur des ports alternatifs).&lt;/p&gt;

&lt;p&gt;Si vous comptez utiliser tmail pour envoyer des mails, pensez à mettre un reverse sur l&amp;rsquo;IP (ou les IP) de votre serveur.&lt;/p&gt;

&lt;p&gt;Pensez aussi à renseigner les SPF des domaines que vous allez utiliser comme émetteurs le cas échéant.&lt;/p&gt;

&lt;p&gt;A noter que comme backend pour la base de données vous pouvez utiliser sqlite, MySQl (et dérivés) ou Postgresql. Je tiens cependant à signaler que je n&amp;rsquo;ai pas fais de tests sous PosgreSQL.
Si vous hésitez, je vous encourage à utiliser sqlite, il n&amp;rsquo;y a aucune installation spécifique, c&amp;rsquo;est rapide et sera amplement suffisant pour le moment.&lt;/p&gt;

&lt;p&gt;A terme, tmail sera splitté en composants sous forme de containers Docker, dans ce qui suit je vais juste expliquer l&amp;rsquo;installation &amp;ldquo;standalone&amp;rdquo; (vs cluster).&lt;/p&gt;

&lt;h3 id=&#34;dependances-outils:b68dafd7755f74812ae92f74ce38ff42&#34;&gt;Dependances &amp;amp; outils&lt;/h3&gt;

&lt;p&gt;Votre serveur devra disposer des softs suivant:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;unzip: pour décrompresser l&amp;rsquo;archive contenant le necessaire à la mise en place de tmail.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Si vous etes sous Debian/Ubuntu:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;apt-get install unzip
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;note-sur-l-utilisation-des-ports-inférieurs-à-1024:b68dafd7755f74812ae92f74ce38ff42&#34;&gt;Note sur l&amp;rsquo;utilisation des ports inférieurs à 1024&lt;/h3&gt;

&lt;p&gt;Sur un système linux un processus ne peut ouvrir un port inférieur à 1024 que si il est root.
Une des limitations de Go fait que l&amp;rsquo;on ne peut pas lancer d&amp;rsquo;application sous l&amp;rsquo;utilisateur root pour ouvrir les ports nécessaires et ensuite &lt;em&gt;forker&lt;/em&gt; sous un autre user.&lt;br /&gt;
Il y à plusieurs autres solutions pour contourner ce problème, la plus simple à mettre en œuvre est d&amp;rsquo;utiliser iptables. C&amp;rsquo;est ce que nous allons faire ici.&lt;/p&gt;

&lt;h2 id=&#34;installation:b68dafd7755f74812ae92f74ce38ff42&#34;&gt;Installation&lt;/h2&gt;

&lt;h3 id=&#34;ajout-de-l-utilisateur-tmail:b68dafd7755f74812ae92f74ce38ff42&#34;&gt;Ajout de l&amp;rsquo;utilisateur tmail&lt;/h3&gt;

&lt;p&gt;On va commencer par ajouter un utilisateur tmail&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;adduser tmail
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;téléchargement-de-tmail:b68dafd7755f74812ae92f74ce38ff42&#34;&gt;Téléchargement de tmail&lt;/h3&gt;

&lt;p&gt;J&amp;rsquo;ai mis sur mon FTP une archive comprenant le binaire et divers autre éléments utiles pour installer tmail.&lt;/p&gt;

&lt;p&gt;On va donc commencer par récupérer cette archive et la décompresser.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# su tmail
$ cd
$ wget ftp://ftp.toorop.fr/softs/tmail/tmail.zip
$ unzip tmail.zip
$ cd dist
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Le répertoire &lt;em&gt;dist&lt;/em&gt; contient les éléments nécessaires pour lancer tmail:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ ls -la
drwxrwxr-x 5 tmail tmail     4096 févr.  2 09:08 .
drwxr-xr-x 3 tmail tmail     4096 févr.  2 09:08 ..
drwxrwxr-x 2 tmail tmail     4096 févr.  2 09:08 conf
-rw-rw-r-- 1 tmail tmail       38 janv. 16 15:14 run
drwx------ 2 tmail tmail     4096 déc.  29 12:02 ssl
-rwxr-xr-x 1 tmail tmail 14370520 janv. 28 16:34 tmail
drwxrwxr-x 2 tmail tmail     4096 déc.  29 11:20 tpl
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Avant de vous détailler ces différents éléments, on va fixer quelques droits, (il se peut que ce ne soit pas toujours nécessaire mais dans tous les cas pensez à vérifier):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;chmod 700 run tmail 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;et on va rajouter deux répertoires:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;mkdir db
mkdir store 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;si vous souhaitez gérer des boites mail, vous pouvez créer le dossiers &lt;em&gt;mailboxes&lt;/em&gt; qui contiendra les différents comptes.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;mkdir mailboxes     
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;conf: contient, oh surprise, le fichier de configuration.&lt;/li&gt;
&lt;li&gt;run: est un mini script qui va charger la config et lancer tmail.&lt;/li&gt;
&lt;li&gt;ssl: est le répertoire contenant le nécessaire pour gérer le SSL. Vous pouvez utiliser ce qui est inclus dans la distribution dans le cadre de tests mais pensez à créer vos propres certificat et clé en prod (si besoin je ferais un tuto).&lt;/li&gt;
&lt;li&gt;tmail: est l&amp;rsquo;exécutable.&lt;/li&gt;
&lt;li&gt;tpl: contient des templates, par exemple pour les bounces.&lt;/li&gt;
&lt;li&gt;db: contiendra la base sqlite (si vous utilisez sqlite&amp;hellip;)&lt;/li&gt;
&lt;li&gt;store: va servir au stockage des mails en queue. Vous pouvez le mettre ailleurs mais pensez à faire la modification dans le fichier de configuration. A terme, il va y avoir d&amp;rsquo;autre type se &lt;em&gt;store&lt;/em&gt; que du stockage sur le disque local.&lt;/li&gt;
&lt;li&gt;mailboxes: les boites mails des utilisateurs&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;configuration:b68dafd7755f74812ae92f74ce38ff42&#34;&gt;Configuration&lt;/h2&gt;

&lt;p&gt;On va commencer par copier le ficher tmail.cfg.base vers tmail.cfg car c&amp;rsquo;est ce dernier qui sera pris en compte:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cd conf
cp tmail.cfg.base tmail.cfg
chmod 600 tmail.cfg 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Je ne vais parler que des options qu&amp;rsquo;il va être nécessaire de modifier:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;TMAIL_ME: C&amp;rsquo;est le nom d’hôte de votre serveur, celui qui va être utilisé, entre autre, dans la commande HELO/EHLO. Personnalisez cette valeur pour qu&amp;rsquo;elle corresponde au reverse de votre IP.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;TMAIL_DEBUG_ENABLED: si positionné à &lt;em&gt;true&lt;/em&gt; vous allez avoir toutes les info de debug. Pour une sortie moins verbeuse mettez false, mais je ne vous le conseille pas dans le cadre de ces tests.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;TMAIL_DB_DRIVER: la base de données utilisées. Notez que pour le moment j&amp;rsquo;utilise exclusivement sqlite3, les autres devraient fonctionner mais je ne garantis rien.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;TMAIL_DB_SOURCE: la source des données.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;TMAIL_SMTPD_DSNS: cette option va nous permettre de définir les IP:port d&amp;rsquo;écoute de tmail et si on doit activer SSL ou pas. A noter que si SSL n&amp;rsquo;est pas activé on a tout de même l&amp;rsquo;option ESMTP STARTTLS qui permet d&amp;rsquo;avoir des transactions chiffrées si le client supporte STARTTLS.
Dans notre cas on veut que tmail écoute sur l&amp;rsquo;IP publique du serveur 151.80.115.83, sur les port 25 et 587 et sur le port 465 en SSL. Comme l&amp;rsquo;utilisateur tmail ne peut ouvrir ces ports on va utiliser 2525 5877 et 4655 et on fera de la redirection de port. On a donc:
TMAIL_SMTPD_DSNS=&amp;ldquo;151.80.115.83:2525:false;151.80.115.83:5877:false;151.80.115.83:4655:true&amp;rdquo;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;TMAIL_DELIVERD_LOCAL_IPS: c&amp;rsquo;est l&amp;rsquo;IP (ou les IP) locale(s) à utiliser pour envoyer des mails. Pour ce premier test on va faire simple, on va utiliser une seule adresse, celle par défaut du serveur: export TMAIL_DELIVERD_LOCAL_IPS=&amp;ldquo;151.80.115.83&amp;rdquo;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;TMAIL_DELIVERD_MAX_IN_FLIGHT: correspond au nombre de &amp;ldquo;delivery&amp;rdquo;, autrement dit d&amp;rsquo;envois concurrents.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;TMAIL_DELIVERD_QUEUE_LIFETIME: correspond au temps de rétention en queue avant qu&amp;rsquo;un mail ne soit bouncé si tmail n&amp;rsquo;arrive pas à l’expédier. Par défaut le temps est très court, si il vous prend l&amp;rsquo;envie d&amp;rsquo;utiliser tmail en prod (ce que je ne vous conseille pas de faire en l&amp;rsquo;état) augmentez le.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Si vous souhaitez activer le filtrage antivirus de votre flux SMTP, &lt;a href=&#34;http://tmail.io/doc/filtrage-smtp-antivirus-clamav&#34;&gt;consultez ce billet&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Si vous souhaitez gérer des boites mail consulter ce billet: &lt;a href=&#34;http://tmail.io/doc/mailboxes/&#34;&gt;Gérez vos boites mail avec tmail&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Un fois cette configuration faite, on peut lancer lancer tmail.&lt;/p&gt;

&lt;p&gt;Vu que c&amp;rsquo;est un premier lancement tmail va détecter que la base de données n&amp;rsquo;est pas initialisée et il va vous demander si il peut le faire:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tmail@dev:~/dist$ ./run 
Database &#39;driver: sqlite3, source: /home/tmail/dist/db/tmail.db&#39; misses some tables.
Should i create them ? (y/n): y

je vous passe les info de debug..

[dev.tmail.io - 127.0.0.1] 2015/02/02 12:42:32.449597 INFO - smtpd 151.80.115.83:2525 launched.
[dev.tmail.io - 127.0.0.1] 2015/02/02 12:42:32.449931 INFO - smtpd 151.80.115.83:5877 launched.
[dev.tmail.io - 127.0.0.1] 2015/02/02 12:42:32.450011 INFO - smtpd 151.80.115.83:4655 SSL launched.
[dev.tmail.io - 127.0.0.1] 2015/02/02 12:42:32.499728 INFO - deliverd launched
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;redirection-de-ports-via-iptables:b68dafd7755f74812ae92f74ce38ff42&#34;&gt;Redirection de ports via iptables&lt;/h3&gt;

&lt;p&gt;Pour que tmail écoute sur les ports standards nous allons mettre en place les trois règles suivantes. Attention assurez vous que vous n&amp;rsquo;avez pas déjà un serveur SMTP qui écoute sur ces ports, si c&amp;rsquo;est le cas et que vous ne souhaitez pas l’arrêter, utilisez simplement tmail sur les port alternatifs.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;iptables -t nat -A PREROUTING -p tcp --dport 25 -j REDIRECT --to-port 2525
iptables -t nat -A PREROUTING -p tcp --dport 465 -j REDIRECT --to-port 4655
iptables -t nat -A PREROUTING -p tcp --dport 587 -j REDIRECT --to-port 5877
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;le-moment-est-venu-de-faire-un-premier-test:b68dafd7755f74812ae92f74ce38ff42&#34;&gt;Le moment est venu de faire un premier test&lt;/h3&gt;

&lt;p&gt;Vous pouvez faire le test depuis la même machine mais tant qu&amp;rsquo;a faire, faites le depuis une autre.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ telnet dev.tmail.io 25
Trying 151.80.115.83...
Connected to dev.tmail.io.
Escape character is &#39;^]&#39;.
220 tmail.io  tmail ESMTP f22815e0988b8766b6fe69cbc73fb0d965754f60
HELO toto
250 tmail.io
MAIL FROM: toorop@toorop.fr
250 ok
RCPT TO: toorop@toorop.fr
554 5.7.1 &amp;lt;toorop@toorop.fr&amp;gt;: Relay access denied.
Connection closed by foreign host.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Parfait !
Pour le moment le mail est refusé car nous n&amp;rsquo;avons défini aucune autorisation.&lt;/p&gt;

&lt;h3 id=&#34;prise-en-charge-des-mails-du-domaine-toorop-fr:b68dafd7755f74812ae92f74ce38ff42&#34;&gt;Prise en charge des mails du domaine toorop.fr&lt;/h3&gt;

&lt;p&gt;Pour que tmail prenne en charge les mails du domaine toorop.fr il suffit tout simplement d&amp;rsquo;exécuter la commande suivante:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tmail rcpthost add toorop.fr
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Par défaut tmail va considérer qu&amp;rsquo;il doit juste relayer les mails du domaine concerné, si vous voulez que tmail considere ce domaine comme local, dans le cas ou vous voulez que tmail gére les boites mail du domaine voud devez ajouter l&amp;rsquo;option -l true:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tmail rcpthost add -l toorop.fr
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Pour ce premier test, on va juste demander à tmail de prendre en charge les mails du domaine et de les relayer, donc n&amp;rsquo;ajouter pas cette option.&lt;/p&gt;

&lt;p&gt;Si vous avez une erreur du type:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;2015/02/02 15:51:30 unable to load config from env, TMAIL_ME variable is missing.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;C&amp;rsquo;est parce que la configuration n&amp;rsquo;est pas chargée dans votre environnement, pour y remédier exécuter:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;. /home/tmail/dist/conf/tmail.cfg
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Vérifions que tmail accepte les mails pour toorop.fr:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ telnet dev.tmail.io 25
Trying 151.80.115.83...
Connected to dev.tmail.io.
Escape character is &#39;^]&#39;.
220 tmail.io  tmail ESMTP 96b78ef8f850253cc956820a874e8ce40773bfb7
HELO toto
250 tmail.io
mail from: toorop@toorop.fr
250 ok
rcpt to: toorop@toorop.fr
250 ok
data
354 End data with &amp;lt;CR&amp;gt;&amp;lt;LF&amp;gt;.&amp;lt;CR&amp;gt;&amp;lt;LF&amp;gt;
subject: test tmail

blabla
.
250 2.0.0 Ok: queued 2736698d73c044fd7f1994e76814d737c702a25e
quit
221 2.0.0 Bye
Connection closed by foreign host.
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;router-les-mails-à-destination-du-domaine-toorop-fr-vers-mail-toorop-fr:b68dafd7755f74812ae92f74ce38ff42&#34;&gt;Router les mails à destination du domaine toorop.fr vers mail.toorop.fr&lt;/h3&gt;

&lt;p&gt;Par défaut quand tmail doit router un mail, il va utiliser les enregistrements DNS MX du domaine pour savoir à qui le transmettre. Mais nous pouvons aussi créer des routes &amp;ldquo;en dur&amp;rdquo;. Par exemple si nous souhaitons que tmail transmette les mails à destination du domaine toorop.fr au relais mail.toorop.fr il suffit de lui indiquer via cette commande :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tmail routes add -d toorop.fr -rh mail.toorop.fr
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Je vous invite lire la documentation sur les &lt;a href=&#34;http://tmail.io/doc/cli-gestion-route-smtp/&#34;&gt;régles de routage SMTP&lt;/a&gt; pour connaitre les possibilités offertes par tmail.&lt;/p&gt;

&lt;h3 id=&#34;ajout-de-utilisateur-smtp-toorop-toorop-fr:b68dafd7755f74812ae92f74ce38ff42&#34;&gt;Ajout de utilisateur SMTP toorop@toorop.fr&lt;/h3&gt;

&lt;p&gt;Si vous souhaitez ajouter un utilisateur &lt;em&gt;toorop@toorop.fr&lt;/em&gt; qui pourra envoyer des mails via tmail en s&amp;rsquo;authentifiant via SMTPAUTH avec le mot de passe &lt;em&gt;password&lt;/em&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tmail user add -r toorop@toorop.fr password 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;L&amp;rsquo;option -r signifie que l&amp;rsquo;utilisateur, si il s&amp;rsquo;authentifie, est authorisé à relayé.&lt;/p&gt;

&lt;p&gt;Pour supprimer un utilisateur:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tmail user del toorop@toorop.fr
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;tmux:b68dafd7755f74812ae92f74ce38ff42&#34;&gt;tmux&lt;/h3&gt;

&lt;p&gt;Pour que tmail ne s&amp;rsquo;arrete pas lorsque vous quitterez votre session, vous avez pouvez le lancer en utilisant:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    ./run &amp;amp;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;mais tmail affichant ces logs sur la sortie standard je vous recommande plutot d&amp;rsquo;utilser tmux (ou screen):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;apt-get install tmux
tmux
./run
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Pour vous détacher de la session:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;Ctrl&amp;gt; + &amp;lt;b&amp;gt; suivi de &amp;lt;d&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a href=&#34;http://doc.ubuntu-fr.org/tmux&#34; target=&#34;_blank&#34;&gt; Plus d&amp;rsquo;information sur tmux.&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;vous-avez-trouvé-un-bug:b68dafd7755f74812ae92f74ce38ff42&#34;&gt;Vous avez trouvé un bug ?&lt;/h3&gt;

&lt;p&gt;Utilisez le &lt;a href=&#34;https://github.com/Toorop/tmail-bugtracker&#34;&gt;bugtracker dédié sur Github&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;discuter-du-projet:b68dafd7755f74812ae92f74ce38ff42&#34;&gt;Discuter du projet&lt;/h3&gt;

&lt;p&gt;J&amp;rsquo;ai mis en place &lt;a href=&#34;https://groups.google.com/d/forum/tmail-dev&#34;&gt;un groupe de discussion&lt;/a&gt; sur Google Groups pour discuter du projet. N&amp;rsquo;hésitez pas à soumettre vos suggestions.&lt;/p&gt;

&lt;p&gt;Bon tests ;)&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Gestion des routes SMTP en utilisant le CLI</title>
      <link>http://tmail.io/doc/cli-gestion-route-smtp/</link>
      <pubDate>Wed, 28 Jan 2015 09:15:12 +0100</pubDate>
      
      <guid>http://tmail.io/doc/cli-gestion-route-smtp/</guid>
      <description>

&lt;p&gt;Vous pouvez gérer les routes SMTP sortantes directement en ligne de commande, ce document vous donne les références concernant les fonctionnalités implémentées.&lt;/p&gt;

&lt;p&gt;Avant d&amp;rsquo;aller plus loin je vous recommande la lecture de la &lt;a href=&#34;http://tmail.io/doc/routes-smtp-sortantes/&#34;&gt;documentation expliquant le fonctionnement des routes SMTP&lt;/a&gt; principalement pour savoir l&amp;rsquo;ordre dans lequel les règles sont testées. Il faut savoir que la première route qui correspond sera celle qui sera utilisée, donc si vous ne voulez pas avoir de surprise il est capital de bien assimiler ce point.&lt;/p&gt;

&lt;h3 id=&#34;lister-toutes-les-routes:253091a785f27e2f20aac978da09c51f&#34;&gt;Lister toutes les routes&lt;/h3&gt;

&lt;p&gt;La commande pour lister les routes est:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tmail routes list

1 - Destination host: toorop.fr - Prority: 1 - Local IPs: default - Remote host: mail.toorop.fr:25
2 - Destination host: tmail.io - Prority: 1 - Local IPs: default - Remote host: mail.tmail.io:25
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Pour le moment il n&amp;rsquo;y a pas de paramètres pour spécifier des critères de recherche. Si vous avez besoin de rechercher une route particulière, le plus simple pour le moment est d&amp;rsquo;utiliser l&amp;rsquo;outil &lt;em&gt;grep&lt;/em&gt; pour filtrer la sortie de la commande &lt;em&gt;tmail routes list&lt;/em&gt;.&lt;br /&gt;
Par exemple si vous voulez chercher les routes faisant référence au domaine tmail.io :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tmail routes list | grep tmail.io
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;ajouter-une-régle-de-routage-smtp:253091a785f27e2f20aac978da09c51f&#34;&gt;Ajouter une régle de routage SMTP&lt;/h3&gt;

&lt;h4 id=&#34;aide-en-ligne:253091a785f27e2f20aac978da09c51f&#34;&gt;Aide en ligne&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;tmail routes add --help
NAME:
    add - Add a route
USAGE:
    command add [command options] [arguments...]
DESCRIPTION:
    tmail routes add -d DESTINATION_HOST -rh REMOTE_HOST [-rp REMOTE_PORT] [-p PRORITY] [-l LOCAL_IP] [-u AUTHENTIFIED_USER] [-f MAIL_FROM] [-rl REMOTE_LOGIN] [-rpwd REMOTE_PASSWD]

OPTIONS:
    --destination, -d       hostame destination, eg domain in rcpt user@domain
    --remote host, --rh         remote host, eg where email should be deliver
    --remotePort, --rp &amp;quot;25&amp;quot; Route port
    --priority, -p &amp;quot;1&amp;quot;      Route priority. Lowest-numbered priority routes are the most preferred
    --localIp, -l       Local IP(s) to use. If you want to add multiple IP separate them by | for round-robin or &amp;amp; for failover. Don&#39;t mix &amp;amp; and |
    --smtpUser, -u      Routes for authentified user user.
    --mailFrom, -f      Routes for MAIL FROM. User need to be authentified
    --remoteLogin, --rl         SMTPauth login for remote host
    --remotePasswd, --rpwd  SMTPauth passwd for remote host
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;exemples:253091a785f27e2f20aac978da09c51f&#34;&gt;Exemples&lt;/h4&gt;

&lt;p&gt;Ajouter une route pour relayer les mails à destination du domaine tmail.io vers mail.tmail.io&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tmail routes add -d tmail.io -rh mail.tmail.io
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Vous pouvez spécifier un port distant&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tmail routes add -d tmail.io -rh mail.tmail.io -rp 2525 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Si le serveur distant nécessite une authentification SMTP ajouter les options rl et rpwd&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tmail route add -d tmail.io -rh mail.tmail.io -rp 587 -rl login -rpwd passwd
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Vous pouvez créer des routes qui vont agir en fonction de l&amp;rsquo;utilisateur qui à soumis le mail ( à la condition bien entendu qu&amp;rsquo;il se soit authentifié via SMTPAUTH). Imaginons par exemple que vous souhaitiez router les mails soumis par l&amp;rsquo;utilisateur toorop@tmail.io vers le relais premium.tmail.io&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tmail route add -rh premium.tmail.io -u toorop@tmail.io
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Si vous voulez attribuer une route spécifique à tous les utilisateurs d&amp;rsquo;un domaine, la solution consiste  à utiliser leur adresse email comme login SMTP et ensuite de créer une règle en mettant le domaine comme valeur pour l&amp;rsquo;option u. Par exemple si vous souhaitez que les mails de tous les utilisateurs identifiés comme faisant partie du domaine domaine tmail.io aient leurs mails routés par Mailjet :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tmail route add -rh in.mailjet.com -u tmail.io -rl mailjet_login -rpwd mailjet_passwd
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Si vous voulez ajouter comme contrainte que l’expéditeur du mail (MAIL FROM) doit etre en @tmail.io :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; tmail route add -rh in.mailjet.com -u tmail.io -f tmail.io -rl mailjet_login -rpwd mailjet_passwd
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;round-robin:253091a785f27e2f20aac978da09c51f&#34;&gt;Round Robin&lt;/h4&gt;

&lt;p&gt;Vous pouvez mettre deux (ou plus) routes identiques. Bien entendu ça n&amp;rsquo;a aucun intérêt si ce sont les seules routes pour une destination donnée, mais dans le cas contraire cela permet de repartir les mails vers plusieurs relais en leur attribuant un poids. Par exemple imaginons que nous souhaitions faire passer deux fois plus de mails par big.smtp.tmail.io que par small.smtp.tmail.io :&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tmail route add -d tmail.io -rh big.smtp.tmail.io
tmail route add -d tmail.io -rh big.smtp.tmail.io
tmail route add -d tmail.io -rh small.smtp.tmail.io
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;failover:253091a785f27e2f20aac978da09c51f&#34;&gt;Failover&lt;/h4&gt;

&lt;p&gt;En ajoutant un paramètre de priorité, vous pouvez créer des routes secondaires qui vont qui vont etres utilisé sur les routes de priorité plus élevées sont en échecs.&lt;/p&gt;

&lt;p&gt;Par exemple:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tmail route add -d tmail.io -rh main.smtp.tmail.io -p 1
tmail route add -d tmail.io -rh alt1.smtp.tmail.io -p 2
tmail route add -d tmail.io -rh alt2.smtp.tmail.io -p 3
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Dans ce cas tmail va d&amp;rsquo;abord tenter de transmettre le mail à main.smtp.tmail.io puis ça ça échoue à alt1.smtp.tmail.io et si ça échoue toujours à alt2.smtp.tmail.io&lt;/p&gt;

&lt;p&gt;Notez que vous pouvez mixer failover et roundrobin, par exemple:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tmail route add -d tmail.io -rh main.smtp.tmail.io -p 1
tmail route add -d tmail.io -rh alt1.smtp.tmail.io -p 2
tmail route add -d tmail.io -rh alt2.smtp.tmail.io -p 2
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Dans ce cas si tmail n&amp;rsquo;arrive pas a transmettre le mail à main.smtp.tmail.io il va faire le second essais vers alt1 ou alt2.&lt;/p&gt;

&lt;h3 id=&#34;supprimer-une-règle-de-routage-smtp:253091a785f27e2f20aac978da09c51f&#34;&gt;Supprimer une règle de routage SMTP&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;tmail routes del ROUTE_ID
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>Gestion de la queue en utilisant le CLI</title>
      <link>http://tmail.io/doc/cli-gestion-queue/</link>
      <pubDate>Wed, 21 Jan 2015 14:20:24 +0100</pubDate>
      
      <guid>http://tmail.io/doc/cli-gestion-queue/</guid>
      <description>

&lt;h4 id=&#34;lister-les-messages-en-queue:a5ae8842e5f4cb42bab09bbc9c21cead&#34;&gt;Lister les messages en queue&lt;/h4&gt;

&lt;p&gt;La commande pour lister les messages en queue est:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tmail queue list
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Pour chaque mail en queue les informations suivantes sont retournées:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Identifiant du mail en queue&lt;/li&gt;
&lt;li&gt;From: expéditeur du mail&lt;/li&gt;
&lt;li&gt;To:  destinataire du mail&lt;/li&gt;
&lt;li&gt;Status: status du mail. Actuellement les status sont &amp;ldquo;Delivery in progress&amp;rdquo;, &amp;ldquo;Scheduled&amp;rdquo;, &amp;ldquo;Will be discarded&amp;rdquo;, &amp;ldquo;Will be bounced&amp;rdquo;&lt;/li&gt;
&lt;li&gt;Next delivery process scheduled at: Dans le cas ou un mail est en attente dans la queue ce paramètre indique le moment (approximatif) où le mail sera représenté au process tmail qui traite les message en queue.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Cas où il n&amp;rsquo;y a pas de message en queue:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tmail queue list

There is no message in queue.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Cas où il y a un message en queue qui est en train d&amp;rsquo;être délivré:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tmail queue list

1 messages in queue.

12564 - From: toorop@toorop.fr - To: toorop@toorop.fr - Status: Delivery in progress - Added: 2015-01-23 09:10:40.271449372 +0100 CET 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Cas où il y un message en queue en attente:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;1 messages in queue.
12564 - From: toorop@toorop.fr - To: toorop@toorop.fr - Status: Scheduled - Added: 2015-01-23 09:10:40.271449372 +0100 CET - Next delivery process scheduled at: 2015-01-23 09:14:40.464895229 +0100 CET
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;supprimer-un-message-discard:a5ae8842e5f4cb42bab09bbc9c21cead&#34;&gt;Supprimer un message (discard)&lt;/h4&gt;

&lt;p&gt;La commande suivante va vous permettre de supprimer un message de la queue:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tmail discard MESSAGE_ID
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Attention le mail ne sera pas supprimé instantanément, il le sera lorsqu&amp;rsquo;il sera présenté à tmail pour être traité.&lt;/p&gt;

&lt;p&gt;Dans la mesure du possible il est préférable de bouncer un mail plutôt que de le supprimer pour que l&amp;rsquo;expéditeur soit informé du fait que son mail n&amp;rsquo;a pas abouti.&lt;/p&gt;

&lt;h4 id=&#34;bouncer-un-message:a5ae8842e5f4cb42bab09bbc9c21cead&#34;&gt;Bouncer un message&lt;/h4&gt;

&lt;p&gt;Bouncer un message consiste à le supprimer de la queue et à envoyer un message à l&amp;rsquo;expéditeur pour l&amp;rsquo;informer que son mail n&amp;rsquo;est pas arrivé à destination.&lt;/p&gt;

&lt;p&gt;La commande pour bouncer un mail est:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    tmail bounce MESSAGE_ID
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Comme pour la commande discard, le bounce n&amp;rsquo;est pas instantané il se fera lorsque le mail sera représenté à tmail pour être délivré.&lt;/p&gt;

&lt;h4 id=&#34;relancer-la-queue-flush:a5ae8842e5f4cb42bab09bbc9c21cead&#34;&gt;Relancer la queue (flush)&lt;/h4&gt;

&lt;p&gt;Pour le moment cette commande n&amp;rsquo;est pas implémentée. En attendant, pour relancer la queue il vous suffit de relancer tmail.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Routes smtp sortantes</title>
      <link>http://tmail.io/doc/routes-smtp-sortantes/</link>
      <pubDate>Mon, 19 Jan 2015 16:38:23 +0100</pubDate>
      
      <guid>http://tmail.io/doc/routes-smtp-sortantes/</guid>
      <description>&lt;p&gt;&lt;strong&gt;tmail vous permet de spécifier des routes sortantes pour les mails qu&amp;rsquo;il a à expédier.&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Par défaut, lorsque tmail doit transmettre un mail il va faire une requête DNS MX pour obtenir les adresses IP du/des serveur(s) SMTP du domaine de destination. C&amp;rsquo;est le fonctionnement classique d&amp;rsquo;un serveur SMTP, mais vous pouvez aussi créer des règles de routage pour forcer les connexions sortantes vers des relais spécifiques.&lt;/p&gt;

&lt;p&gt;Les règles de routage vont êtres définies an fonction des paramètres suivants :&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Le domaine de destination.&lt;/li&gt;
&lt;li&gt;L&amp;rsquo;expéditeur à la condition que le mail ait été originalement transmis à tmail par un utilisateur authentifié (via SMTP AUTH).&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Lorsque tmail à un mail à transmettre il va chercher parmi les règles suivantes si il y en a une qui correspond.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;Si il trouve une règle&lt;/strong&gt;, il va utiliser les routes qui correspondent à cette règle. Chaque route à un poids, comme pour les MX classiques, tmail va donc essayer en premier lieu de se connecter au relais suivant en utilisant la route qui a le poids le plus faible. Dans le cas où plusieurs routes ont le même poids, il va les ordonner aléatoirement ce qui va permettre de faire facilement du round-robin.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;Si il n&amp;rsquo;en trouve pas&lt;/strong&gt;, il va utiliser les MX du domaine de destination.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Les règles sont testées dans l&amp;rsquo;ordre suivant:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;Si le mail à été transmis via SMTPAUTH:&lt;/strong&gt; tmail va chercher une règle liée à l&amp;rsquo;utilisateur authentifié qui correspond à l&amp;rsquo;expéditeur (MAIL FROM de l’enveloppe SMTP) et au domaine de destination.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;Si le mail à été transmis via SMTPAUTH:&lt;/strong&gt; tmail va chercher une règle liée à l&amp;rsquo;utilisateur authentifié qui correspond au domaine de l&amp;rsquo;expéditeur (MAIL FROM de l’enveloppe SMTP) et au domaine de destination.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;Si le mail à été transmis via SMTPAUTH:&lt;/strong&gt; tmail va chercher une règle liée à l&amp;rsquo;utilisateur authentifié qui correspond au domaine de destination.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;Si le mail à été transmis via SMTPAUTH:&lt;/strong&gt; tmail va chercher une règle &amp;lsquo;générique&amp;rsquo; liée à l&amp;rsquo;utilisateur authentifié.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;tmail va chercher une règle qui correspond au domaine de destination.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;tmail va chercher une règle par défaut (wildcard &amp;ldquo;*&amp;rdquo; sur le domaine de destination)&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Par &lt;em&gt;règle liée à l&amp;rsquo;utilisateur authentifié&lt;/em&gt; j&amp;rsquo;entends une règle liée au login complet de cet utilisateur, ou si il n&amp;rsquo;y en a pas et que ce login est de la forme user@domaine.tld un règle liée à domaine.tld&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://tmail.io/doc/cli-gestion-queue/&#34;&gt;Vous pouvez configurer les règles de routage en utilisante le CLI&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>